<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>–¢–∞–∫—Å–∏ –ë–∞—Ä—Å - –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #000;
      --primary-dark: #1a1a1a;
      --background-light: #f8f9fa;
      --background-medium: #f0f0f0;
      --border-color: #d9d9d9;
      --text-color: #212121;
      --text-secondary: #616161;
      --card-bg: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.03);
      --shadow-medium: rgba(0, 0, 0, 0.08);
      --error-color: #d32f2f;
      --success-color: #2e7d32;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background-color: var(--background-light);
      color: var(--text-color);
      line-height: 1.5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .order-container {
      max-width: 480px;
      width: 100%;
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px var(--shadow-light);
      position: relative;
      margin: 10px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 20px);
      max-height: 800px;
      border: 1px solid var(--border-color);
    }
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-bar {
      height: 3px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin: 16px 0 10px;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 2px;
      width: 33.33%;
      transition: width 0.5s ease;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-top: 8px;
    }
    .progress-step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
      padding: 0 4px;
    }
    .step-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .step-label.active {
      color: var(--primary-color);
      font-weight: 600;
    }
    .step-marker {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #e0e0e0;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      color: var(--text-color);
      border: 2px solid var(--card-bg);
      transition: all 0.3s ease;
    }
    .step-marker.active {
      background: var(--primary-color);
      color: white;
    }
    .step-marker.completed {
      background: var(--success-color);
      color: white;
    }
    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ) */
    .status-notification {
      padding: 10px 14px;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: var(--shadow-light);
      text-align: left;
      font-size: 14px;
      color: var(--text-color);
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 12px;
      position: relative;
      overflow: hidden;
      border: none;
    }
    .status-notification::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 4px;
      background: var(--primary-color);
    }
    .status-notification.waiting::before {
      background: #9e9e9e;
    }
    .status-notification.warning::before {
      background: #ff9800;
    }
    .status-notification.error::before {
      background: var(--error-color);
    }
    .status-notification.success::before {
      background: var(--success-color);
    }
    .notification-icon {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 16px;
    }
    .notification-warning .notification-icon {
      color: #ff9800;
    }
    .notification-error .notification-icon {
      color: var(--error-color);
    }
    .notification-success .notification-icon {
      color: var(--success-color);
    }
    .notification-text {
      line-height: 1.4;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    .notification-actions {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .notification-btn {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .notification-btn.retry {
      background: #e0e0e0;
      color: var(--text-color);
    }
    .notification-btn.retry:hover {
      background: #d5d5d5;
    }
    .notification-btn.primary {
      background: var(--primary-color);
      color: white;
    }
    .notification-btn.primary:hover {
      background: var(--primary-dark);
    }
    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è */
    .info-section {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }
    .info-card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px var(--shadow-light);
    }
    .info-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .info-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--background-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      flex-shrink: 0;
      color: var(--text-color);
      font-size: 16px;
    }
    .info-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-color);
    }
    .driver-car-container {
      background: var(--card-bg);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light);
      margin-bottom: 16px;
    }
    .driver-section {
      display: flex;
      padding: 16px;
      background: var(--background-light);
      border-bottom: 1px solid var(--border-color);
    }
    .driver-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, #333 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      font-weight: bold;
      flex-shrink: 0;
      border: 2px solid var(--card-bg);
      margin-right: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .driver-info {
      flex: 1;
    }
    .driver-name-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .driver-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-color);
    }
    .driver-badge {
      background: var(--background-medium);
      color: var(--text-color);
      font-size: 12px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .driver-badge i {
      font-size: 12px;
    }
    .driver-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: #ffc107;
      margin-bottom: 8px;
    }
    .driver-rating span {
      color: var(--text-secondary);
      margin-left: 4px;
    }
    .car-section {
      padding: 16px;
    }
    .car-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .car-model {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-color);
    }
    .car-details {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .car-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .car-feature {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--background-light);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
    }
    .car-feature i {
      font-size: 14px;
      color: var(--primary-color);
    }
    .driver-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .driver-btn {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .driver-btn:hover {
      background: var(--background-light);
      transform: translateY(-1px);
    }
    .driver-btn.message {
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .driver-btn.message:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ */
    .route-styled {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light);
      margin-bottom: 16px;
    }
    .route-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--background-light);
      border-bottom: 1px solid var(--border-color);
    }
    .route-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .route-title i {
      color: var(--text-color);
      font-size: 16px;
    }
    .route-toggle {
      background: none;
      border: none;
      color: var(--primary-color);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }
    .route-content {
      padding: 20px 16px;
      position: relative;
    }
    .route-line-container {
      position: relative;
      padding-left: 56px;
      margin: 10px 0;
    }
    .route-line {
      position: absolute;
      left: 28px;
      top: 24px;
      bottom: 24px;
      width: 2px;
      background: var(--border-color);
    }
    .route-point {
      display: flex;
      margin-bottom: 24px;
      position: relative;
      z-index: 2;
    }
    .route-point:last-child {
      margin-bottom: 0;
    }
    .point-marker {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 0;
      top: -6px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 3;
    }
    .point-marker.start {
      background: var(--primary-color);
      color: white;
      border: 3px solid white;
    }
    .point-marker.end {
      background: var(--background-medium);
      color: var(--text-color);
      border: 3px solid white;
    }
    .point-info {
      flex: 1;
      min-width: 0;
      padding-left: 48px;
    }
    .point-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 2px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .point-label i {
      font-size: 14px;
    }
    .point-address {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-color);
      line-height: 1.4;
      word-wrap: break-word;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .point-address.full {
      -webkit-line-clamp: unset;
    }
    .route-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .route-details.active {
      max-height: 500px;
    }
    .route-info {
      background: var(--background-light);
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
    }
    .route-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .route-info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }
    .info-value.highlight {
      color: var(--primary-color);
    }
    /* –§—É—Ç–µ—Ä —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º */
    .order-footer {
      padding: 16px 20px 20px;
      border-top: 1px solid var(--border-color);
      background: var(--card-bg);
      position: sticky;
      bottom: 0;
    }
    .order-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .info-item {
      text-align: center;
    }
    .info-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }
    .info-value.price {
      font-size: 18px;
      color: var(--text-color);
    }
    .action-buttons {
      display: flex;
      gap: 12px;
    }
    .action-btn {
      flex: 1;
      padding: 13px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      border: none;
    }
    .cancel-btn {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .cancel-btn:hover {
      background: var(--background-light);
    }
    .cancel-btn:disabled {
      background: var(--background-medium);
      color: var(--text-secondary);
      cursor: not-allowed;
      border-color: var(--border-color);
    }
    .finish-btn {
      background: var(--primary-color);
      color: white;
    }
    .finish-btn:hover {
      background: var(--primary-dark);
    }
    .finish-btn:disabled {
      background: var(--background-medium);
      color: var(--text-secondary);
      cursor: not-allowed;
    }
    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã */
    .cancel-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1000;
      max-width: 480px;
      margin: 0 auto;
      border-top: 1px solid var(--border-color);
    }
    .cancel-modal.active {
      transform: translateY(0);
    }
    .cancel-modal-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
    }
    .cancel-modal-header::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
    }
    .cancel-modal-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--background-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: var(--primary-color);
      font-size: 24px;
    }
    .cancel-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
      text-align: center;
    }
    .cancel-modal-text {
      font-size: 16px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .modal-btn {
      flex: 1;
      padding: 16px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .no-btn {
      background: var(--background-light);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .no-btn:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    .yes-btn {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .yes-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .order-container {
      opacity: 0;
      transform: translateY(15px);
      animation: fadeInUp 0.4s ease forwards;
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* –ü–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    /* –í—Ä–µ–º–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .temp-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 10000;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }
    @media (max-width: 480px) {
      .order-container {
        margin: 5px;
        border-radius: 14px;
      }
      .driver-avatar {
        width: 56px;
        height: 56px;
        font-size: 24px;
      }
      .driver-name {
        font-size: 17px;
      }
      .action-btn {
        padding: 12px;
        font-size: 14px;
      }
      .info-value.price {
        font-size: 18px;
      }
      .progress-steps {
        margin-bottom: 16px;
      }
      .point-address {
        font-size: 14px;
      }
      .route-content {
        padding: 16px;
      }
      .status-notification {
        font-size: 13px;
        padding: 10px 12px;
      }
      .cancel-modal {
        padding: 20px 16px;
      }
      .modal-btn {
        padding: 14px;
        font-size: 15px;
      }
    }
    @media (max-height: 650px) {
      .order-container {
        height: auto;
        max-height: 90vh;
      }
      .info-section {
        padding: 12px;
      }
      .route-styled {
        margin-bottom: 12px;
      }
    }
    /* –î–ª—è iOS PWA */
    @supports (padding: max(0px)) {
      .order-container {
        margin-top: max(10px, env(safe-area-inset-top));
        margin-bottom: max(10px, env(safe-area-inset-bottom));
      }
      .confirmation-screen {
        padding-top: calc(env(safe-area-inset-top) + 20px);
        padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
        padding-left: calc(env(safe-area-inset-left) + 20px);
        padding-right: calc(env(safe-area-inset-right) + 20px);
      }
    }
  </style>
</head>
<body>
  <div class="order-container">
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-steps">
        <div class="progress-step">
          <div class="step-marker active" id="step1">1</div>
          <div class="step-label active" id="label1">–í–æ–¥–∏—Ç–µ–ª—å<br>–≤ –ø—É—Ç–∏</div>
        </div>
        <div class="progress-step">
          <div class="step-marker" id="step2">2</div>
          <div class="step-label" id="label2">–í–æ–¥–∏—Ç–µ–ª—å<br>–æ–∂–∏–¥–∞–µ—Ç</div>
        </div>
        <div class="progress-step">
          <div class="step-marker" id="step3">3</div>
          <div class="step-label" id="label3">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
        </div>
      </div>
      <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ -->
      <div class="status-notification waiting" id="statusNotification">
        <div class="notification-icon">
          <i class="fas fa-car"></i>
        </div>
        <div class="notification-text" id="statusText">
          –í–æ–¥–∏—Ç–µ–ª—å –±—É–¥–µ—Ç —É –≤–∞—Å —á–µ—Ä–µ–∑ <span id="etaText">5</span> –º–∏–Ω—É—Ç
        </div>
      </div>
    </div>
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="info-section">
      <!-- –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
      <div class="driver-car-container">
        <!-- –°–µ–∫—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è -->
        <div class="driver-section">
          <div class="driver-avatar" id="driverAvatar">
            –ê
          </div>
          <div class="driver-info">
            <div class="driver-name-row">
              <div class="driver-name" id="driverName">–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ç—Ä–æ–≤</div>
              <div class="driver-badge">
                <i class="fas fa-shield-alt"></i>
                <span>–ü—Ä–æ–≤–µ—Ä–µ–Ω</span>
              </div>
            </div>
            <div class="driver-rating" id="driverRatingContainer">
              <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Ä–µ–π—Ç–∏–Ω–≥ -->
            </div>
          </div>
        </div>
        <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
        <div class="car-section">
          <div class="car-info-row">
            <div class="car-model" id="carModel">Skoda Octavia</div>
          </div>
          <div class="car-details" id="carDetails">2022 –≥. | –°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π | –ê 123 –í–° 777</div>
          <div class="car-features">
            <div class="car-feature">
              <i class="fas fa-user-friends"></i>
              <span id="passengerCount">4</span> –º–µ—Å—Ç–∞
            </div>
            <div class="car-feature">
              <i class="fas fa-suitcase"></i>
              <span>3 —á–µ–º–æ–¥–∞–Ω–∞</span>
            </div>
            <div class="car-feature">
              <i class="fas fa-snowflake"></i>
              <span>–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä</span>
            </div>
            <div class="car-feature">
              <i class="fas fa-tint"></i>
              <span>–ö–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å</span>
            </div>
          </div>
          <div class="driver-actions">
            <button class="driver-btn message" id="messageDriverBtn">
              <i class="fas fa-comment-alt"></i>
              <span>–°–æ–æ–±—â–µ–Ω–∏–µ</span>
            </button>
          </div>
        </div>
      </div>
      <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ -->
      <div class="route-styled">
        <div class="route-header">
          <div class="route-title">
            <i class="fas fa-route"></i>
            <span>–ú–∞—Ä—à—Ä—É—Ç</span>
          </div>
          <button class="route-toggle" id="toggleRouteDetails">
            <i class="fas fa-info-circle"></i>
            <span>–î–µ—Ç–∞–ª–∏</span>
          </button>
        </div>
        <div class="route-content">
          <div class="route-line-container">
            <div class="route-line"></div>
            <div class="route-point">
              <div class="point-marker start">
                <i class="fas fa-location-arrow" style="font-size: 16px; transform: rotate(-45deg);"></i>
              </div>
              <div class="point-info">
                <div class="point-label">
                  <i class="fas fa-dot-circle"></i>
                  <span>–û—Ç–∫—É–¥–∞</span>
                </div>
                <div class="point-address" id="pickupAddress">—É–ª. –õ–µ–Ω–∏–Ω–∞, 15, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫, –†–æ—Å—Å–∏—è</div>
              </div>
            </div>
            <div class="route-point">
              <div class="point-marker end">
                <i class="fas fa-flag-checkered" style="font-size: 14px;"></i>
              </div>
              <div class="point-info">
                <div class="point-label">
                  <i class="fas fa-map-pin"></i>
                  <span>–ö—É–¥–∞</span>
                </div>
                <div class="point-address" id="dropoffAddress">—É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, 42, –û—Ñ–∏—Å–Ω—ã–π —Ü–µ–Ω—Ç—Ä ¬´–ì–æ—Ä–æ–¥¬ª, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫, –†–æ—Å—Å–∏—è</div>
              </div>
            </div>
          </div>
          <div class="route-details" id="routeDetails">
            <div class="route-info">
              <div class="route-info-row">
                <div class="info-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                <div class="info-value highlight" id="distanceDisplay">5.3 –∫–º</div>
              </div>
              <div class="route-info-row">
                <div class="info-label">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏</div>
                <div class="info-value highlight" id="timeDisplay">12 –º–∏–Ω—É—Ç</div>
              </div>
              <div class="route-info-row">
                <div class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                <div class="info-value highlight" id="priceDisplay">320 ‚ÇΩ</div>
              </div>
              <div class="route-info-row">
                <div class="info-label">–ü—Ä–æ–±–∫–∏</div>
                <div class="info-value" id="trafficDisplay">–£–º–µ—Ä–µ–Ω–Ω—ã–µ</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- –§—É—Ç–µ—Ä —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º -->
    <div class="order-footer">
      <div class="order-info">
        <div class="info-item">
          <div class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
          <div class="info-value price" id="footerPrice">320 ‚ÇΩ</div>
        </div>
        <div class="info-item">
          <div class="info-label">–í—Ä–µ–º—è</div>
          <div class="info-value" id="footerTime">12 –º–∏–Ω</div>
        </div>
        <div class="info-item">
          <div class="info-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
          <div class="info-value" id="footerDistance">5.3 –∫–º</div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="action-btn cancel-btn" id="cancelOrder">
          <i class="fas fa-times"></i>
          <span>–û—Ç–º–µ–Ω–∏—Ç—å</span>
        </button>
        <button class="action-btn finish-btn" id="endOrder" disabled>
          <i class="fas fa-check"></i>
          <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
        </button>
      </div>
    </div>
  </div>
  <!-- –ü–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <!-- –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã -->
  <div class="cancel-modal" id="cancelModal">
    <div class="cancel-modal-header">
      <div class="cancel-modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
    </div>
    <h3 class="cancel-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã</h3>
    <p class="cancel-modal-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
    <div class="modal-buttons">
      <button class="modal-btn no-btn" id="noCancel">
        <i class="fas fa-times"></i>
        <span>–ù–µ—Ç</span>
      </button>
      <button class="modal-btn yes-btn" id="yesCancel">
        <i class="fas fa-check"></i>
        <span>–î–∞</span>
      </button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
      const API_BASE_URL = window.location.hostname === 'localhost' ? 
        'http://localhost:8004' : 'https://taxibarsnz24.ru';
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏–∑ localStorage
      const orderData = JSON.parse(localStorage.getItem('activeOrderData'));
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
      if (!orderData || !orderData.orderId) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        window.location.href = 'main.html';
        return;
      }
      
      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
      const cancelOrderBtn = document.getElementById('cancelOrder');
      const endOrderBtn = document.getElementById('endOrder');
      const stepMarkers = document.querySelectorAll('.step-marker');
      const stepLabels = document.querySelectorAll('.step-label');
      const progressFill = document.getElementById('progressFill');
      const statusNotification = document.getElementById('statusNotification');
      const cancelModal = document.getElementById('cancelModal');
      const modalOverlay = document.getElementById('modalOverlay');
      const noCancelBtn = document.getElementById('noCancel');
      const yesCancelBtn = document.getElementById('yesCancel');
      let currentStep = 1;
      let pollInterval;

      // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–•
      function initializeOrderData() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞:', orderData);
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.getElementById('driverName').textContent = orderData.driverName || '–í–æ–¥–∏—Ç–µ–ª—å';
        document.getElementById('driverAvatar').textContent = orderData.driverInitials || 
            (orderData.driverName ? orderData.driverName.charAt(0) : '–í');
        document.getElementById('carModel').textContent = orderData.carBrand || '–ê–≤—Ç–æ–º–æ–±–∏–ª—å';
        document.getElementById('carDetails').textContent = 
            `${orderData.carYear || '‚Äî'} –≥. | ${orderData.carColor || '‚Äî'} | ${orderData.carNumber || '‚Äî'}`;
        document.getElementById('pickupAddress').textContent = orderData.pickupAddress || '‚Äî';
        document.getElementById('dropoffAddress').textContent = orderData.dropoffAddress || '‚Äî';
        document.getElementById('passengerCount').textContent = orderData.passengers || '1';
        
        // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
        const etaMatch = (orderData.estimatedTime || '5 –º–∏–Ω—É—Ç').match(/(\d+)/);
        const etaMinutes = etaMatch ? parseInt(etaMatch[1]) : 5;
        document.getElementById('etaText').textContent = etaMinutes;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        const distance = orderData.distanceKm || orderData.distance_km || 0;
        document.getElementById('distanceDisplay').textContent = `${distance} –∫–º`;
        const estimatedTime = orderData.estimatedTime || orderData.estimated_time_min || '15 –º–∏–Ω—É—Ç';
        document.getElementById('timeDisplay').textContent = estimatedTime;
        document.getElementById('priceDisplay').textContent = `${orderData.price || '‚Äî'} ‚ÇΩ`;
        document.getElementById('trafficDisplay').textContent = '–£–º–µ—Ä–µ–Ω–Ω—ã–µ';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ—É—Ç–µ—Ä–µ
        document.getElementById('footerPrice').textContent = `${orderData.price} ‚ÇΩ`;
        document.getElementById('footerTime').textContent = orderData.estimatedTime || '‚Äî';
        document.getElementById('footerDistance').textContent = `${orderData.distanceKm} –∫–º`;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤–æ–¥–∏—Ç–µ–ª—è
        initializeDriverRating();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        initializeMessageButton();
      }

      // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ï–ô–¢–ò–ù–ì–ê –í–û–î–ò–¢–ï–õ–Ø
      function initializeDriverRating() {
        const driverRatingContainer = document.getElementById('driverRatingContainer');
        const driverRating = orderData.driverRating || 4.8;
        
        // –û–∫—Ä—É–≥–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –¥–æ 1 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        const roundedRating = parseFloat(driverRating.toFixed(1));
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–≤–µ–∑–¥—ã
        let starsHTML = '';
        const fullStars = Math.floor(roundedRating);
        const hasHalfStar = (roundedRating - fullStars) >= 0.5;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –∑–≤–µ–∑–¥—ã
        for (let i = 0; i < fullStars; i++) {
          starsHTML += '<i class="fas fa-star"></i>';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–æ–≤–∏–Ω—á–∞—Ç—É—é –∑–≤–µ–∑–¥—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if (hasHalfStar) {
          starsHTML += '<i class="fas fa-star-half-alt"></i>';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∑–≤–µ–∑–¥—ã –¥–æ 5
        const remainingStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < remainingStars; i++) {
          starsHTML += '<i class="far fa-star"></i>';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞
        driverRatingContainer.innerHTML = `
          ${starsHTML}
          <span id="driverRating">${roundedRating}</span>
        `;
      }

      // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø
function initializeMessageButton() {
  const messageDriverBtn = document.getElementById('messageDriverBtn');
  
  messageDriverBtn.addEventListener('click', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª—è
    if (!orderData.driverId && !orderData.driverUsername) {
      showTempNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è');
      return;
    }
    
    let appLink = '';
    let webLink = '';
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Telegram
    if (orderData.driverUsername) {
      const cleanUsername = orderData.driverUsername.replace('@', '');
      appLink = `tg://resolve?domain=${cleanUsername}`;
      webLink = `https://t.me/${cleanUsername}`;
    } else if (orderData.driverId && /^\d+$/.test(orderData.driverId)) {
        appLink = `tg://user?id=${orderData.driverId}`;
        webLink = `https://web.telegram.org/k/#u${orderData.driverId}`;
    } else {
      showTempNotification('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –≤–æ–¥–∏—Ç–µ–ª—è');
        return;
      }
    

    if (!appLink) {
      showTempNotification('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è');
      return;
    }
    
    // –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const startTime = Date.now();
    
    try {
      // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—É—é iframe –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ iframe
      iframe.src = appLink;
      
      // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ 1000–º—Å, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–µ–±-–≤–µ—Ä—Å–∏–∏
      setTimeout(() => {
        document.body.removeChild(iframe);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        if (Date.now() - startTime < 2000 && !document.hidden) {
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
          window.open(webLink, '_blank');
          showTempNotification(`üí¨ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é.`);
        }
      }, 1000);
      
      showTempNotification(`üí¨ –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å ${orderData.driverName}`);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ Telegram:', error);
      window.open(webLink, '_blank');
      showTempNotification(`üí¨ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–≤–µ—Ä—Å–∏—é.`);
    }
  });
}

      // üî• –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°-–ë–ê–†–ê
      function updateProgress(step, driverArrived = false) {
        console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ —à–∞–≥ ${step}, driver_arrived: ${driverArrived}`);
        
        currentStep = step;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
        stepMarkers.forEach((marker, index) => {
          if (index + 1 < step) {
            marker.className = 'step-marker completed';
          } else if (index + 1 === step) {
            marker.className = 'step-marker active';
          } else {
            marker.className = 'step-marker';
          }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–æ–∫
        stepLabels.forEach((label, index) => {
          if (index + 1 === step) {
            label.className = 'step-label active';
          } else {
            label.className = 'step-label';
          }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        const progressPercent = (step - 1) * 50;
        progressFill.style.width = `${progressPercent}%`;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
        if (step === 1) {
          document.getElementById('statusText').innerHTML = `–í–æ–¥–∏—Ç–µ–ª—å –±—É–¥–µ—Ç —É –≤–∞—Å —á–µ—Ä–µ–∑ <b>${document.getElementById('etaText').textContent}</b> –º–∏–Ω—É—Ç`;
          statusNotification.className = 'status-notification waiting';
          cancelOrderBtn.disabled = false;
          endOrderBtn.disabled = true;
        } else if (step === 2) {
          document.getElementById('statusText').innerHTML = '–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞ –º–µ—Å—Ç–µ! –£ –≤–∞—Å 5 –º–∏–Ω—É—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è';
          statusNotification.className = 'status-notification warning';
          cancelOrderBtn.disabled = true;
          endOrderBtn.disabled = false;
        } else if (step === 3) {
          document.getElementById('statusText').innerHTML = '–ü–æ–µ–∑–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!';
          statusNotification.className = 'status-notification success';
          cancelOrderBtn.disabled = true;
          endOrderBtn.disabled = true;
        }
        
        console.log(`‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —à–∞–≥ ${step}`);
      }

// üî• –û–ü–†–û–° –°–¢–ê–¢–£–°–ê –ó–ê–ö–ê–ó–ê
function startOrderStatusPolling() {
  console.log('üîÑ –ó–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞...');
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
  if (pollInterval) {
    clearInterval(pollInterval);
  }
  
  pollInterval = setInterval(async () => {
    try {
      console.log(`üîÑ –û–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderData.orderId}...`);
      
      const response = await fetch(`${API_BASE_URL}/api/web/order/${orderData.orderId}`);
      if (!response.ok) {
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:', response.status);
        return;
      }
      
      const result = await response.json();
      console.log('üìä –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
      
      if (result.success && result.order) {
        const order = result.order;
        console.log(`üì¶ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: ${order.status}, driver_arrived: ${order.driver_arrived}, —Ç–µ–∫—É—â–∏–π —à–∞–≥: ${currentStep}`);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–ª–∞–≥–∞ –ø—Ä–∏–±—ã—Ç–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
        if (order.status === 'accepted') {
          // –í–æ–¥–∏—Ç–µ–ª—å –≤ –ø—É—Ç–∏ –∏–ª–∏ –æ–∂–∏–¥–∞–µ—Ç
          if (order.driver_arrived) {
            // –í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–±—ã–ª –∏ –æ–∂–∏–¥–∞–µ—Ç
            if (currentStep !== 2) {
              updateProgress(2);
              showTempNotification('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–±—ã–ª –Ω–∞ –º–µ—Å—Ç–æ!');
            }
          } else {
            // –í–æ–¥–∏—Ç–µ–ª—å –≤ –ø—É—Ç–∏
            if (currentStep !== 1) {
              updateProgress(1);
              showTempNotification('üöó –í–æ–¥–∏—Ç–µ–ª—å –≤ –ø—É—Ç–∏ –∫ –≤–∞–º');
            }
          }
        } else if (order.status === 'completed') {
          // –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω
          if (currentStep !== 3) {
            updateProgress(3);
            showTempNotification('üéâ –ü–æ–µ–∑–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
            

// –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –ó–ê–ö–ê–ó–ê –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –û–¶–ï–ù–ö–ò
            const orderForRating = {
                orderId: orderData.orderId,
                driverId: orderData.driverId,
                driverName: orderData.driverName,
                driverInitials: orderData.driverInitials,
                carBrand: orderData.carBrand,
                carNumber: orderData.carNumber,
                price: orderData.price,
                distanceKm: orderData.distanceKm,
                estimatedTime: orderData.estimatedTime,
                pickupAddress: orderData.pickupAddress,
                dropoffAddress: orderData.dropoffAddress,
                driverRating: orderData.driverRating || 4.8,
                passengers: orderData.passengers || 1
            };

            const result = await response.json();
            if (result.success) {
                // –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –í LOCALSTORAGE –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –û–¶–ï–ù–ö–ò
                localStorage.setItem('orderForRating', JSON.stringify(orderForRating));
                localStorage.removeItem('activeOrderData');
                saveCompletedOrderToHistory(orderData);
              }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              localStorage.removeItem('activeOrderData');
              saveCompletedOrderToHistory(orderData);
              window.location.href = 'rate-driver.html';
              //showCompletionScreen();
            }, 4000);
          }
        } else if (order.status === 'cancelled') {
          // –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω
          console.log('üî¥ –°—Ç–∞—Ç—É—Å: cancelled - –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω');
          if (pollInterval) {
            clearInterval(pollInterval);
          }
          showCancelScreen();
        }
      } else {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞:', result);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:', error);
    }
  }, 3000); // –û–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
}

      // üî• –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–¨–ù–´–ú –û–ö–ù–û–ú –û–¢–ú–ï–ù–´
      function initializeCancelModal() {
        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã
        cancelOrderBtn.addEventListener('click', () => {
          cancelModal.classList.add('active');
          modalOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–µ—Ç" –∏–ª–∏ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        noCancelBtn.addEventListener('click', closeCancelModal);
        modalOverlay.addEventListener('click', closeCancelModal);
        
        function closeCancelModal() {
          cancelModal.classList.remove('active');
          modalOverlay.classList.remove('active');
          document.body.style.overflow = 'auto';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–î–∞"
        yesCancelBtn.addEventListener('click', async () => {
          try {
            closeCancelModal();
            
            if (pollInterval) {
              clearInterval(pollInterval);
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É –∑–∞–∫–∞–∑–∞
            const response = await fetch(`${API_BASE_URL}/api/web/order/${orderData.orderId}/cancel`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                reason: 'client_cancelled'
              })
            });
            
            if (!response.ok) {
              throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞: ${response.status}`);
            }
            
            const result = await response.json();
            if (result.success) {
              localStorage.removeItem('activeOrderData');
              showCancelScreen();
            } else {
              throw new Error(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑');
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞: ${error.message}`);
          }
        });
      }

      // üî• –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê
function initializeCompleteOrder() {
    endOrderBtn.addEventListener('click', async () => {
        try {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            // –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –ó–ê–ö–ê–ó–ê –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –û–¶–ï–ù–ö–ò
            const orderForRating = {
                orderId: orderData.orderId,
                driverId: orderData.driverId,
                driverName: orderData.driverName,
                driverInitials: orderData.driverInitials,
                carBrand: orderData.carBrand,
                carNumber: orderData.carNumber,
                price: orderData.price,
                distanceKm: orderData.distanceKm,
                estimatedTime: orderData.estimatedTime,
                pickupAddress: orderData.pickupAddress,
                dropoffAddress: orderData.dropoffAddress,
                driverRating: orderData.driverRating || 4.8,
                passengers: orderData.passengers || 1
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥
            updateProgress(3);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            const response = await fetch(`${API_BASE_URL}/api/web/order/${orderData.orderId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ${response.status}`);
            }
            
            const result = await response.json();
            if (result.success) {
                // –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –í LOCALSTORAGE –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –û–¶–ï–ù–ö–ò
                localStorage.setItem('orderForRating', JSON.stringify(orderForRating));
                localStorage.removeItem('activeOrderData');
                saveCompletedOrderToHistory(orderData);
                
                // –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –°–¢–†–ê–ù–ò–¶–£ –û–¶–ï–ù–ö–ò
                window.location.href = 'rate-driver.html';
            } else {
                throw new Error(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ${error.message}`);
        }
    });
}

      // üî• –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –î–ï–¢–ê–õ–ï–ô –ú–ê–†–®–†–£–¢–ê
      function initializeRouteToggle() {
        const toggleRouteDetails = document.getElementById('toggleRouteDetails');
        const routeDetails = document.getElementById('routeDetails');
        let isRouteExpanded = false;
        
        toggleRouteDetails.addEventListener('click', () => {
          isRouteExpanded = !isRouteExpanded;
          routeDetails.classList.toggle('active', isRouteExpanded);
          toggleRouteDetails.innerHTML = isRouteExpanded ? 
            '<i class="fas fa-chevron-up"></i> <span>–°–∫—Ä—ã—Ç—å</span>' : 
            '<i class="fas fa-info-circle"></i> <span>–î–µ—Ç–∞–ª–∏</span>';
        });
      }

      // üî• –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
      function showTempNotification(message) {
        const tempNotification = document.createElement('div');
        tempNotification.className = 'temp-notification';
        tempNotification.textContent = message;
        document.body.appendChild(tempNotification);
        
        setTimeout(() => {
          tempNotification.style.animation = 'slideUp 0.3s ease';
          setTimeout(() => {
            if (tempNotification.parentNode) {
              tempNotification.parentNode.removeChild(tempNotification);
            }
          }, 300);
        }, 3000);
      }

      function saveCompletedOrderToHistory(orderData) {
        const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
        const completedOrder = {
          id: `order_${Date.now()}`,
          date: new Date().toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }),
          from: orderData.pickupAddress,
          to: orderData.dropoffAddress,
          price: `${orderData.price} ‚ÇΩ`,
          distance: orderData.distanceKm || '‚Äî',
          status: 'completed',
          driver: orderData.driverName,
          order_id: orderData.orderId
        };
        history.unshift(completedOrder);
        if (history.length > 10) history.pop();
        localStorage.setItem('orderHistory', JSON.stringify(history));
      }


// –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã
function showCancelScreen() {
    document.body.innerHTML = `
    <div class="cancel-screen" style="max-width:480px;width:100%;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.03);margin:10px;">
        <div style="padding:40px 20px;text-align:center;">
            <div style="font-size:48px;color:#d32f2f;margin-bottom:20px;">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2 style="font-size:24px;font-weight:600;margin-bottom:16px;">–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω</h2>
            <p style="font-size:16px;color:#616161;margin-bottom:30px;">–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞.</p>
            <div style="text-align:left;background:#f8f9fa;border-radius:14px;padding:16px;margin-bottom:24px;font-size:14px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
                    <span style="font-weight:600;">#${orderData.orderId}</span>
                </div>
                <div style="display:flex;justify-content:space-between;">
                    <span>–í—Ä–µ–º—è –æ—Ç–º–µ–Ω—ã:</span>
                    <span>${new Date().toLocaleTimeString('ru-RU')}</span>
                </div>
            </div>
            <button class="action-btn" onclick="location.href='main.html'" 
                style="background:#000;color:white;padding:16px;border-radius:14px;font-size:16px;font-weight:600;width:100%;border:none;cursor:pointer;">
                <i class="fas fa-arrow-left"></i>
                <span>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </button>
        </div>
    </div>
    <style>
        body { 
            background: #f8f9fa; 
            margin:0; 
            padding:0; 
            min-height:100vh; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
    </style>`;
}

// –≠–∫—Ä–∞–Ω –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
function showCancelScreenn() {
    document.body.innerHTML = `
    <div class="cancel-screen" style="max-width:480px;width:100%;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.03);margin:10px;">
        <div style="padding:40px 20px;text-align:center;">
            <div style="font-size:48px;color:#d32f2f;margin-bottom:20px;">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2 style="font-size:24px;font-weight:600;margin-bottom:16px;">–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω</h2>
            <p style="font-size:16px;color:#616161;margin-bottom:30px;">–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞.</p>
            <div style="text-align:left;background:#f8f9fa;border-radius:14px;padding:16px;margin-bottom:24px;font-size:14px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
                    <span style="font-weight:600;">#${orderData.orderId}</span>
                </div>
                <div style="display:flex;justify-content:space-between;">
                    <span>–í—Ä–µ–º—è –æ—Ç–º–µ–Ω—ã:</span>
                    <span>${new Date().toLocaleTimeString('ru-RU')}</span>
                </div>
            </div>
            <button class="action-btn" onclick="location.href='main.html'" 
                style="background:#000;color:white;padding:16px;border-radius:14px;font-size:16px;font-weight:600;width:100%;border:none;cursor:pointer;">
                <i class="fas fa-arrow-left"></i>
                <span>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </button>
        </div>
    </div>
    <style>
        body { 
            background: #f8f9fa; 
            margin:0; 
            padding:0; 
            min-height:100vh; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
    </style>`;
}

// –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
function showCompletionScreen() {
    document.body.innerHTML = `
    <div class="review-screen" style="max-width:480px;width:100%;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.03);margin:10px;">
        <div class="review-header" style="padding:32px 24px 16px;text-align:center;position:relative;">
            <div class="review-check" style="width:64px;height:64px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <div class="review-check-icon" style="font-size:32px;color:#000;">
                    <i class="fas fa-check"></i>
                </div>
            </div>
            <h2 class="review-title" style="font-size:24px;font-weight:600;color:#212121;margin-bottom:8px;line-height:1.3;">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–µ–∑–¥–∫—É!</h2>
            <div class="review-subtitle" style="font-size:15px;font-weight:400;color:#616161;opacity:0.9;max-width:360px;margin:0 auto;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–µ–∑–¥–∫–∏ –∏ –≤–æ–¥–∏—Ç–µ–ª—è. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —É–ª—É—á—à–∏—Ç—å —Å–µ—Ä–≤–∏—Å.</div>
        </div>
        
        <div class="review-rating" style="padding:24px 20px 0;text-align:center;">
            <div class="stars-container" style="display:flex;justify-content:center;gap:12px;margin:16px 0;">
                <i class="fas fa-star star" data-rating="1" style="font-size:28px;color:#e0e0e0;cursor:pointer;"></i>
                <i class="fas fa-star star" data-rating="2" style="font-size:28px;color:#e0e0e0;cursor:pointer;"></i>
                <i class="fas fa-star star" data-rating="3" style="font-size:28px;color:#e0e0e0;cursor:pointer;"></i>
                <i class="fas fa-star star" data-rating="4" style="font-size:28px;color:#e0e0e0;cursor:pointer;"></i>
                <i class="fas fa-star star" data-rating="5" style="font-size:28px;color:#e0e0e0;cursor:pointer;"></i>
            </div>
            <div class="rating-prompt" style="font-size:14px;color:#616161;margin-top:8px;display:block;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å</div>
        </div>
        
        <div class="review-textarea-container" style="padding:0 20px 20px;text-align:center;">
            <textarea class="review-textarea" placeholder="–í–∞—à –æ—Ç–∑—ã–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width:100%;max-width:360px;margin:0 auto;padding:14px 16px;border:1px solid #d9d9d9;border-radius:12px;font-size:15px;resize:vertical;min-height:80px;max-height:150px;transition:border-color 0.2s;background:#f8f9fa;"></textarea>
            <div class="review-hint" style="font-size:13px;color:#616161;margin-top:6px;text-align:center;display:none;">–î–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∏–∂–µ 4 –∑–≤–µ–∑–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω</div>
            <div class="error-message" style="font-size:13px;color:#d32f2f;margin-top:6px;text-align:center;display:none;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –Ω–∏–∑–∫–æ–π –æ—Ü–µ–Ω–∫–∏</div>
        </div>
        
        <div class="trip-info" style="background:#f8f9fa;border-radius:14px;padding:18px;margin:0 20px 24px;border:1px solid #d9d9d9;text-align:left;">
            <div class="trip-info-row" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d9d9d9;">
                <div class="info-label" style="font-size:14px;color:#616161;">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏:</div>
                <div class="info-value" style="font-size:14px;font-weight:500;color:#212121;">${orderData.price} ‚ÇΩ</div>
            </div>
            <div class="trip-info-row" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d9d9d9;">
                <div class="info-label" style="font-size:14px;color:#616161;">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</div>
                <div class="info-value" style="font-size:14px;font-weight:500;color:#212121;">${orderData.estimatedTime || '‚Äî'}</div>
            </div>
            <div class="trip-info-row" style="display:flex;justify-content:space-between;padding:8px 0;">
                <div class="info-label" style="font-size:14px;color:#616161;">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</div>
                <div class="info-value" style="font-size:14px;font-weight:500;color:#212121;">${orderData.distanceKm || '‚Äî'} –∫–º</div>
            </div>
        </div>
        
        <div class="review-footer" style="padding:16px 24px 24px;border-top:1px solid #d9d9d9;background:#fff;margin-top:auto;">
            <button class="submit-btn" id="submitReview" style="width:100%;padding:16px;border-radius:12px;background:#000;color:white;font-size:15px;font-weight:500;border:none;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);">
                <i class="fas fa-paper-plane"></i>
                <span>–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ó–´–í</span>
            </button>
        </div>
    </div>
    <style>
        body { 
            background: #f8f9fa; 
            margin:0; 
            padding:0; 
            min-height:100vh; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .star.selected {
            color: #000;
        }
        .review-textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }
        .review-textarea.error {
            border-color: #d32f2f;
        }
        .submit-btn:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>`;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setTimeout(() => {
        const stars = document.querySelectorAll('.star');
        const reviewTextarea = document.querySelector('.review-textarea');
        const reviewHint = document.querySelector('.review-hint');
        const errorMessage = document.querySelector('.error-message');
        const submitBtn = document.getElementById('submitReview');
        let selectedRating = 0;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–≤–µ–∑–¥
        stars.forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.rating);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤–µ–∑–¥
                stars.forEach((s, index) => {
                    if (index < selectedRating) {
                        s.classList.add('selected');
                        s.style.color = '#000';
                    } else {
                        s.classList.remove('selected');
                        s.style.color = '#e0e0e0';
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
                if (selectedRating < 4) {
                    reviewHint.style.display = 'block';
                    document.querySelector('.rating-prompt').style.display = 'none';
                } else {
                    reviewHint.style.display = 'none';
                    document.querySelector('.rating-prompt').style.display = 'none';
                }
                
                validateForm();
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            star.addEventListener('mouseenter', () => {
                stars.forEach((s, index) => {
                    if (index < parseInt(star.dataset.rating)) {
                        s.style.color = '#000';
                    } else {
                        s.style.color = '#e0e0e0';
                    }
                });
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            star.addEventListener('mouseleave', () => {
                stars.forEach((s, index) => {
                    if (index < selectedRating) {
                        s.style.color = '#000';
                    } else {
                        s.style.color = '#e0e0e0';
                    }
                });
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        reviewTextarea.addEventListener('input', validateForm);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
        function validateForm() {
            if (selectedRating === 0) {
                submitBtn.disabled = true;
                return;
            }
            
            const isRequired = selectedRating < 4;
            const isCommented = reviewTextarea.value.trim() !== '';
            
            if (isRequired && !isCommented) {
                reviewTextarea.classList.add('error');
                errorMessage.style.display = 'block';
                submitBtn.disabled = true;
            } else {
                reviewTextarea.classList.remove('error');
                errorMessage.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞
        submitBtn.addEventListener('click', () => {
            if (submitBtn.disabled) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
            const reviewData = {
                orderId: orderData.orderId,
                rating: selectedRating,
                comment: reviewTextarea.value.trim(),
                timestamp: new Date().toISOString()
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–∑—ã–≤–æ–≤
            const reviews = JSON.parse(localStorage.getItem('orderReviews')) || [];
            reviews.unshift(reviewData);
            if (reviews.length > 10) reviews.pop();
            localStorage.setItem('orderReviews', JSON.stringify(reviews));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            document.body.innerHTML = `
            <div class="confirmation-screen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:32px 20px;width:100%;height:100%;box-sizing:border-box;max-width:480px;margin:0 auto;position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;z-index:9999;overflow:hidden;">
                <div style="font-size:64px;color:#2e7d32;margin-bottom:20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="font-size:24px;font-weight:600;margin-bottom:16px;">–í–∞—à –æ—Ç–∑—ã–≤ –æ—á–µ–Ω—å –≤–∞–∂–µ–Ω –¥–ª—è –Ω–∞—Å!</h2>
                <div style="font-size:16px;color:#616161;max-width:80%;line-height:1.5;margin:0 auto;">–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥.</div>
            </div>`;
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            setTimeout(() => {
                location.href = 'main.html';
            }, 3000);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        validateForm();
    }, 100);
}

      // üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–ï–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
      function initializeApp() {
        initializeOrderData();
        initializeCancelModal();
        initializeCompleteOrder();
        initializeRouteToggle();
        startOrderStatusPolling();
        
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
      }

      // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      initializeApp();
    });
  </script>
</body>
</html>