<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>–¢–∞–∫—Å–∏ –ë–∞—Ä—Å</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
<!-- –ò–∫–æ–Ω–∫–∞ –¥–ª—è iOS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) -->
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<!-- –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è") -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<!-- –ó–∞–ø—É—Å–∫ –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
<!-- –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è (–±–µ–ª–∞—è / —á—ë—Ä–Ω–∞—è) -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
<!-- –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ iOS -->
  <meta name="apple-mobile-web-app-title" content="–¢–∞–∫—Å–∏ –ë–∞—Ä—Å">
  <style>
    :root {
      --primary-color: #000;
      --primary-dark: #1a1a1a;
      --background-light: #f8f9fa;
      --background-medium: #f0f0f0;
      --border-color: #d9d9d9;
      --text-color: #212121;
      --text-secondary: #616161;
      --card-bg: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.03);
      --shadow-medium: rgba(0, 0, 0, 0.08);
      --shadow-heavy: rgba(0, 0, 0, 0.15);
      --error-color: #d32f2f;
      --success-color: #2e7d32;
      --platinum-color: #e5e4e2;
      --gold-color: #ffd700;
      --silver-color: #c0c0c0;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background-color: var(--background-light);
      color: var(--text-color);
      line-height: 1.5;
      padding-bottom: 20px;
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
    }
    .container {
      max-width: 480px;
      width: 100%;
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px var(--shadow-light);
      position: relative;
      margin: 10px auto;
      border: 1px solid var(--border-color);
    }
    /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
    .auth-loader {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--card-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    .loader-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .loader-text {
      font-size: 18px;
      color: var(--text-color);
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: relative;
      z-index: 20;
    }
    .menu-icon {
      width: 24px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      z-index: 30;
    }
    .menu-line {
      width: 100%;
      height: 2px;
      background: var(--text-color);
      border-radius: 2px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .menu-open .menu-line:nth-child(1) {
      transform: translateY(8px) rotate(45deg);
    }
    .menu-open .menu-line:nth-child(2) {
      opacity: 0;
    }
    .menu-open .menu-line:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg);
    }
    .header-title {
      font-weight: 600;
      font-size: 18px;
      color: var(--text-color);
    }
    .avatar {
      width: 36px;
      height: 36px;
      background: var(--background-medium);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      z-index: 30;
      position: relative;
      transition: transform 0.2s ease;
    }
    .avatar:hover {
      transform: scale(1.05);
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 900;
    }
    .profile-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .profile-modal {
      position: absolute;
      right: 16px;
      top: 56px;
      width: 260px;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-heavy);
      z-index: 950;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .profile-modal.active {
      opacity: 1;
      transform: scale(1);
    }
    .profile-header {
      padding: 16px;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-color) 0%, #333 100%);
      color: white;
      border-radius: 16px 16px 0 0;
    }
    .profile-avatar {
      width: 64px;
      height: 64px;
      margin: 0 auto 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
    }
    .profile-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: white;
    }
    .profile-phone {
      font-size: 14px;
      opacity: 0.9;
    }
    .profile-stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 16px;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      padding: 8px;
    }
    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
    }
    .stat-platinum {
      color: var(--platinum-color);
      font-weight: 700;
    }
    .stat-gold {
      color: var(--gold-color);
      font-weight: 700;
    }
    .stat-silver {
      color: var(--silver-color);
      font-weight: 700;
    }
    .stat-rating {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    /* –ö–∞—Ä—Ç–∞ –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .map-container {
      height: 280px;
      position: relative;
      z-index: 1;
    }
    #map {
      width: 100%;
      height: 100%;
      border-bottom: 1px solid var(--border-color);
    }
    .yandex-credits {
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 10px;
      color: rgba(0,0,0,0.6);
      z-index: 5;
      pointer-events: none;
    }
    .map-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--card-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2;
      transition: opacity 0.3s ease;
    }
    .map-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* –°—Ç–∞—Ç—É—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ */
    .location-status {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 5;
      display: none;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    /* –ê–¥—Ä–µ—Å–∞ */
    .address-section {
      padding: 16px;
      background: var(--card-bg);
      position: relative;
      z-index: 15;
    }
    .address-container {
      display: flex;
      align-items: center;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light);
    }
    .address-field {
      flex: 1;
      padding: 12px 16px;
      position: relative;
    }
    .address-field.start {
      border-right: 1px solid var(--border-color);
    }
    .address-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .address-label i {
      color: var(--primary-color);
      font-size: 14px;
    }
    .address-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 15px;
      color: var(--text-color);
      padding: 4px 0;
      outline: none;
      font-weight: 500;
      min-height: 28px;
      line-height: 1.4;
      white-space: normal;
    }
    .address-input::placeholder {
      color: var(--text-secondary);
      font-weight: 400;
    }
    .swap-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      font-size: 18px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
      flex-shrink: 0;
      margin: 0 8px;
    }
    .swap-btn:hover {
      background: var(--background-light);
    }
    .location-error {
      background: rgba(211, 47, 47, 0.08);
      border: 1px solid var(--error-color);
      border-radius: 12px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
      color: var(--error-color);
      display: none;
    }
    .retry-btn {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s;
    }
    .retry-btn:hover {
      opacity: 0.9;
    }
    /* –ù–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ */
    .quick-addresses {
      position: relative;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      z-index: 100;
      display: none;
      overflow: hidden;
      animation: slideDown 0.3s ease;
      border: 1px solid var(--border-color);
      margin-top: 4px;
    }
    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .quick-address-item {
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.2s;
    }
    .quick-address-item:last-child {
      border-bottom: none;
    }
    .quick-address-item:hover {
      background: var(--background-light);
    }
    .quick-address-item i {
      font-size: 20px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    .quick-address-item:hover i {
      color: var(--primary-color);
    }
    .quick-address-content {
      flex: 1;
      min-width: 0;
    }
    .quick-address-title {
      font-weight: 500;
      font-size: 15px;
      color: var(--text-color);
      display: block;
    }
    .quick-address-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .quick-address-item-edit {
      display: none;
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
    }
    .edit-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 12px;
      text-align: center;
    }
    .quick-address-item-edit input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    .quick-address-item-edit .edit-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .quick-address-item-edit .edit-buttons button {
      flex: 1;
      padding: 6px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .quick-address-item-edit .save-btn {
      background: var(--primary-color);
      color: white;
      border: none;
    }
    .quick-address-item-edit .cancel-btn {
      background: var(--background-light);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    /* –ü–∞—Å—Å–∞–∂–∏—Ä—ã */
    .passengers-section {
      padding: 16px;
      background: var(--background-light);
      border-bottom: 1px solid var(--border-color);
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title i {
      color: var(--primary-color);
      font-size: 16px;
    }
    .passengers-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .passenger-btn {
      height: 48px;
      background: white;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .passenger-btn:hover:not(.active) {
      background: var(--background-medium);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px var(--shadow-light);
    }
    .passenger-btn.active {
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }
    .passenger-btn.active:hover {
      background: var(--primary-dark);
    }
    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .info-section {
      padding: 24px;
      text-align: center;
    }
    .info-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      text-align: left;
    }
    .info-icon {
      width: 24px;
      height: 24px;
      background: var(--background-medium);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
    }
    .info-text {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .price-container {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .price-placeholder, .distance-placeholder {
      width: 100px;
      height: 36px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
    }
    .price-placeholder::after, .distance-placeholder::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,0,0,0.05), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      100% { left: 100%; }
    }
    .placeholder-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
      opacity: 0.7;
    }
    .price-value, .distance-value {
      font-size: 24px;
      color: var(--primary-color);
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .distance-value {
      color: var(--text-secondary);
      font-size: 14px;
    }
    .route-details {
      background: var(--background-light);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 8px;
      color: var(--text-color);
      display: none;
    }
    .route-details.info {
      background: #f8f9fa;
      color: #212121;
      text-align: center;
    }
    .route-details.error {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.1);
    }
    /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
    .comment-section {
      padding: 0 24px;
      margin-bottom: 20px;
    }
    .comment-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      width: fit-content;
      transition: color 0.2s;
    }
    .comment-trigger:hover {
      color: var(--primary-color);
    }
    .comment-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-top: 8px;
      font-size: 14px;
      display: none;
      min-height: 80px;
      resize: vertical;
    }
    .comment-input.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    .quick-comments {
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding: 0 24px;
    }
    .quick-comments.active {
      display: flex;
    }
    .quick-comment-btn {
      background: var(--background-light);
      border: 1px solid var(--border-color);
      border-radius: 50px;
      padding: 6px 14px;
      font-size: 13px;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-comment-btn:hover, .quick-comment-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫–∞–∑–∞ */
    .rent-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 16px;
      width: 100%;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }
    .rent-button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .rent-button:disabled {
      background: var(--background-medium);
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: left 0.3s ease;
      z-index: 100;
      padding-top: 60px;
    }
    .sidebar.active {
      left: 0;
    }
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 99;
    }
    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .sidebar-item {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-item:hover {
      background: var(--background-light);
    }
    .sidebar-item i {
      font-size: 20px;
      color: var(--text-color);
    }
    .sidebar-item.active {
      border-left: 3px solid var(--primary-color);
      background: var(--background-light);
    }
    .sidebar-footer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      padding: 0 24px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
      margin-top: 16px;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≤–æ–¥–∏—Ç–µ–ª—è */
    .driver-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1000;
      max-width: 480px;
      margin: 0 auto;
      border-top: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
    }
    .driver-modal.active {
      transform: translateY(0);
    }
    .driver-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .driver-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
    }
    .driver-modal-timer {
      font-size: 14px;
      color: var(--text-secondary);
      background: var(--background-light);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }
    .drivers-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .driver-card {
      display: flex;
      align-items: center;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      transition: box-shadow 0.2s;
    }
    .driver-card:hover {
      box-shadow: 0 2px 6px var(--shadow-medium);
    }
    .driver-card-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, #333 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      flex-shrink: 0;
      margin-right: 16px;
    }
    .driver-card-info {
      flex: 1;
      min-width: 0;
    }
    .driver-card-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 4px;
    }
    .driver-card-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: var(--text-color);
      margin-bottom: 6px;
    }
    .driver-card-rating i {
      color: #ffc107;
    }
    .driver-card-rating span {
      color: var(--text-secondary);
      margin-left: 4px;
    }
    .driver-car {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .driver-select-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .driver-select-btn:hover {
      background: var(--primary-dark);
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ */
    .history-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 900;
    }
    .history-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .history-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1000;
      max-width: 480px;
      margin: 0 auto;
      border-top: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
    }
    .history-modal.active {
      transform: translateY(0);
    }
    .history-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    .history-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
    }
    .history-modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .history-modal-close:hover {
      background: var(--background-light);
    }
    .history-orders {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .history-order-item {
      padding: 16px;
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.2s;
    }
    .history-order-item:hover {
      box-shadow: 0 2px 6px var(--shadow-medium);
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .order-date {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .order-status {
      font-size: 13px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 8px;
    }
    .status-completed {
      background: rgba(46, 125, 50, 0.1);
      color: var(--success-color);
    }
    .status-canceled {
      background: rgba(211, 47, 47, 0.1);
      color: var(--error-color);
    }
    .route-info {
      margin-bottom: 12px;
    }
    .route-point {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .route-point i {
      color: var(--primary-color);
      font-size: 16px;
    }
    .order-details {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      margin-top: 12px;
    }
    .order-price {
      font-weight: 600;
      color: var(--primary-color);
    }
    .repeat-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .repeat-btn:hover {
      background: var(--primary-dark);
    }
    .empty-history {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .empty-history i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    /* –õ–æ–∞–¥–µ—Ä */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 1000;
      font-size: 16px;
      font-weight: 500;
      display: none;
    }
    .loader.active {
      display: block;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è */
    .search-driver-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 900;
    }
    .search-driver-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .search-driver-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1000;
      max-width: 480px;
      margin: 0 auto;
      border-top: 1px solid var(--border-color);
      text-align: center;
    }
    .search-driver-modal.active {
      transform: translateY(0);
    }
    .search-driver-modal-content {
      padding: 20px;
    }
    .search-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }
    .search-driver-modal h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 12px;
    }
    .search-driver-modal p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }
    .search-timer {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--text-color);
    }
    .cancel-search-btn {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }
    .cancel-search-btn:hover {
      background: #b71c1c;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ */
    .marker-set-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 8px;
      font-size: 14px;
      transition: background 0.2s;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .marker-set-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    .marker-set-mode #map {
      cursor: crosshair !important;
    }
    .marker-set-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 100;
      display: none;
      pointer-events: none;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) scale(0.9); }
      to { opacity: 1; transform: translateX(-50%) scale(1); }
    }
    @keyframes fadeOut {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @media (max-width: 480px) {
      .container {
        margin: 5px;
        border-radius: 14px;
      }
      .passenger-btn {
        height: 42px;
        font-size: 14px;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        10% { opacity: 1; transform: translateX(-50%) translateY(0); }
        90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      }
      @keyframes fadeOut {
        0% { opacity: 1; }
        100% { opacity: 0; }
      }
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="auth-loader" id="authLoader">
    <div class="loader-spinner"></div>
    <div class="loader-text">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
  </div>
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ -->
  <div class="marker-set-indicator" id="markerSetIndicator">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
  <div class="container" id="mainContainer" style="display: none;">
    <!-- –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é -->
    <div class="header">
      <div class="menu-icon" id="menuToggle">
        <span class="menu-line"></span>
        <span class="menu-line"></span>
        <span class="menu-line"></span>
      </div>
      <div class="header-title">–ö–∞—Ä—Ç–∞</div>
      <div class="avatar" id="profileAvatar">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Cpath fill='%23888' d='M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6 3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="User" id="userAvatar">
      </div>
    </div>
    <!-- –°—Ç–∞—Ç—É—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <div class="location-status" id="locationStatus"></div>
    <!-- –ö–∞—Ä—Ç–∞ -->
    <div class="map-container">
      <div class="map-loader" id="mapLoader">
        <div class="map-spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
      </div>
      <div id="map"></div>
      <div class="yandex-credits">–î–∞–Ω–Ω—ã–µ ¬© –Ø–Ω–¥–µ–∫—Å</div>
    </div>
    <!-- –ê–¥—Ä–µ—Å–∞ -->
    <div class="address-section">
      <div class="location-error" id="locationError">
        <div>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
        <button class="retry-btn" id="retryLocation">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
      </div>
      <div class="address-container">
        <div class="address-field start">
          <div class="address-label">
            <i class="fas fa-map-marker-alt"></i>
            <span>–û—Ç–∫—É–¥–∞</span>
          </div>
          <div style="display: flex; align-items: center;">
            <input 
              type="text" 
              id="startAddress" 
              class="address-input" 
              placeholder="–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
              value=""
              autocomplete="off"
              style="flex: 1;"
            >
            <button class="marker-set-btn" id="setStartMarkerBtn" title="–£–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
              <i class="fas fa-map-marker-alt"></i>
            </button>
          </div>
          <input type="hidden" id="startAddressFull" value="">
        </div>
        <button class="swap-btn" id="swapAddresses">
          <i class="fas fa-exchange-alt"></i>
        </button>
        <div class="address-field end">
          <div class="address-label">
            <i class="fas fa-map-marker-alt"></i>
            <span>–ö—É–¥–∞</span>
          </div>
          <div style="display: flex; align-items: center;">
            <input 
              type="text" 
              id="endAddress" 
              class="address-input" 
              placeholder="–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
              value=""
              autocomplete="off"
              style="flex: 1;"
            >
            <button class="marker-set-btn" id="setEndMarkerBtn" title="–£–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
              <i class="fas fa-map-marker-alt"></i>
            </button>
          </div>
          <input type="hidden" id="endAddressFull" value="">
        </div>
      </div>
      <!-- –ù–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ -->
      <div class="quick-addresses" id="quickAddresses">
        <div class="quick-address-item" data-address="current-location">
          <i class="fas fa-location-arrow"></i>
          <div class="quick-address-content">
            <span class="quick-address-title">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
            <span class="quick-address-subtitle" id="current-location-subtitle">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</span>
          </div>
        </div>
        <div class="quick-address-item" data-address="home">
          <i class="fas fa-home"></i>
          <div class="quick-address-content">
            <span class="quick-address-title">–î–æ–º</span>
            <span class="quick-address-subtitle" id="home-subtitle">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
          </div>
        </div>
        <div class="quick-address-item" data-address="work">
          <i class="fas fa-briefcase"></i>
          <div class="quick-address-content">
            <span class="quick-address-title">–†–∞–±–æ—Ç–∞</span>
            <span class="quick-address-subtitle" id="work-subtitle">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
          </div>
        </div>
        <div class="quick-address-item-edit" id="addressEditContainer">
          <div class="edit-title" id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞</div>
          <input type="text" id="addressEditInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
          <div class="edit-buttons">
            <button class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
            <button class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä—ã -->
    <div class="passengers-section">
      <div class="section-title">
        <i class="fas fa-users"></i>
        –ü–∞—Å—Å–∞–∂–∏—Ä—ã
      </div>
      <div class="passengers-grid">
        <button class="passenger-btn active" data-passengers="1">1</button>
        <button class="passenger-btn" data-passengers="2">2</button>
        <button class="passenger-btn" data-passengers="3">3</button>
        <button class="passenger-btn" data-passengers="4">4</button>
        <button class="passenger-btn" data-passengers="5">5+</button>
      </div>
    </div>
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="info-section">
      <div class="info-row">
        <div class="info-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="6" x2="12" y2="12"></line>
            <line x1="12" y1="12" x2="16" y2="16"></line>
          </svg>
        </div>
        <div class="info-text">
          <div>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏</div>
          <div><span id="estimatedTime">–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è</span></div>
        </div>
      </div>
      <div class="price-container">
        <div class="price-placeholder">
          <div class="placeholder-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
        </div>
        <div class="distance-placeholder">
          <div class="placeholder-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
        </div>
      </div>
      <div id="calculated-values" style="display:none;">
        <div class="price-container">
          <div class="price-value" id="priceDisplay">‚Äî ‚ÇΩ</div>
          <div class="distance-value" id="distanceDisplay">‚Äî –∫–º</div>
        </div>
      </div>
      <div class="route-details" id="routeDetails">–ü—Ä–æ–±–∫–∏: —É–º–µ—Ä–µ–Ω–Ω—ã–µ ‚Ä¢ –í—Ä–µ–º—è –±–µ–∑ –ø—Ä–æ–±–æ–∫: 12 –º–∏–Ω</div>
    </div>
    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
    <div class="comment-section">
      <div class="comment-trigger" id="commentTrigger">
        <i class="fas fa-comment-alt"></i>
        –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è
      </div>
      <textarea 
        class="comment-input" 
        id="orderComment" 
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–¥—ä–µ–∑–¥ —Å–æ –¥–≤–æ—Ä–∞, –≤—Å—Ç—Ä–µ—á–∞–π—Ç–µ —Å —Ç–∞–±–ª–∏—á–∫–æ–π –∏–ª–∏ –Ω—É–∂–Ω–∞ –¥–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ"
        rows="3"
      ></textarea>
      <div class="quick-comments" id="quickComments">
        <button class="quick-comment-btn" data-comment="–ù—É–∂–µ–Ω –∑–∞–µ–∑–¥ –≤–æ –¥–≤–æ—Ä">
          <i class="fas fa-building"></i>
          –í–æ –¥–≤–æ—Ä
        </button>
        <button class="quick-comment-btn" data-comment="–ù—É–∂–Ω–æ –¥–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ">
          <i class="fas fa-child"></i>
          –ö—Ä–µ—Å–ª–æ
        </button>
        <button class="quick-comment-btn" data-comment="–í—Å—Ç—Ä–µ—á–∞ —Å —Ç–∞–±–ª–∏—á–∫–æ–π">
          <i class="fas fa-sign"></i>
          –¢–∞–±–ª–∏—á–∫–∞
        </button>
        <button class="quick-comment-btn" data-comment="–ë–æ–ª—å—à–æ–π –±–∞–≥–∞–∂">
          <i class="fas fa-suitcase"></i>
          –ë–∞–≥–∞–∂
        </button>
      </div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ -->
    <div style="padding: 0 24px 24px;">
      <button class="rent-button" id="orderButton" disabled>–ó–ê–ö–ê–ó–ê–¢–¨</button>
    </div>
  </div>
  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-item active" data-action="history">
      <i class="fas fa-history"></i>
      <span>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</span>
    </div>
    <div class="sidebar-item" data-action="promo">
      <i class="fas fa-tag"></i>
      <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
    </div>
    <div class="sidebar-item" data-action="support">
      <i class="fas fa-headset"></i>
      <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
    </div>
    <div class="sidebar-item" data-action="logout">
      <i class="fas fa-sign-out-alt"></i>
      <span>–í—ã—Ö–æ–¥</span>
    </div>
    <div class="sidebar-footer">
      –í–µ—Ä—Å–∏—è 1.8.0 ‚Ä¢ –í–∞—à–∏–¢–∞–∫—Å–∏
    </div>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è -->
  <div class="search-driver-modal-overlay" id="searchDriverModalOverlay"></div>
  <div class="search-driver-modal" id="searchDriverModal">
    <div class="search-driver-modal-content">
      <div class="search-spinner"></div>
      <h3>–ü–æ–∏—Å–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
      <p>–ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞</p>
      <div class="search-timer">
        <span>–í—Ä–µ–º—è –Ω–∞ –ø–æ–∏—Å–∫: </span>
        <span id="searchTimerValue">03:00</span>
      </div>
      <button class="cancel-search-btn" id="cancelSearchBtn">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫</button>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≤–æ–¥–∏—Ç–µ–ª—è -->
  <div class="driver-modal" id="driverModal">
    <div class="driver-modal-header">
      <h3 class="driver-modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</h3>
      <div class="driver-modal-timer" id="driverTimer">–û—Å—Ç–∞–ª–æ—Å—å: <span id="timerValue">02:00</span></div>
    </div>
    <div class="drivers-list"></div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
  <div class="profile-modal-overlay" id="profileModalOverlay"></div>
  <div class="profile-modal" id="profileModal">
    <div class="profile-header">
      <div class="profile-avatar">–ò</div>
      <div class="profile-name">–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</div>
      <div class="profile-phone">+7 (999) 123-45-67</div>
    </div>
    <div class="profile-stats">
      <div class="stat-item">
        <span class="stat-label">–°—Ç–∞—Ç—É—Å</span>
        <span class="stat-value stat-platinum">–ü–ª–∞—Ç–∏–Ω–∞</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">–ó–∞–∫–∞–∑—ã</span>
        <span class="stat-value stat-orders">24</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">–†–µ–π—Ç–∏–Ω–≥</span>
        <div class="stat-value stat-rating">
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star-half-alt"></i>
          <span style="margin-left: 4px;">4.7</span>
        </div>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ -->
  <div class="history-modal-overlay" id="historyModalOverlay"></div>
  <div class="history-modal" id="historyModal">
    <div class="history-modal-header">
      <h3 class="history-modal-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
      <button class="history-modal-close" id="historyModalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="history-orders" id="historyOrdersContainer">
      <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
    </div>
  </div>
  <div class="loader" id="routeLoader">–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç...</div>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=d62a52d9-1485-41e8-a4af-439caa66c9e3&lang=ru_RU" type="text/javascript"></script>
 <script>
 // ======================
// –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ü–†–û–í–ï–†–ö–ò –ê–ö–¢–ò–í–ù–û–ì–û –ó–ê–ö–ê–ó–ê
// ======================
function checkAuth() {
    const authLoader = document.getElementById('authLoader');
    const mainContainer = document.getElementById('mainContainer');
    const userData = localStorage.getItem('tg_user');
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const sessionExpiry = localStorage.getItem('sessionExpiry');
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏
    if (sessionExpiry && Date.now() > parseInt(sessionExpiry)) {
        clearAuthData();
        console.log('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        window.location.href = 'login.html';
        return;
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!userData || !isLoggedIn) {
        clearAuthData();
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        window.location.href = 'login.html';
        return;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    authLoader.querySelector('.loader-text').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...';
    authLoader.style.opacity = '1';
    authLoader.style.display = 'flex';
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑
    checkActiveOrder().then(hasActiveOrder => {
        if (!hasActiveOrder) {
            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            setTimeout(() => {
                authLoader.style.opacity = '0';
                setTimeout(() => {
                    authLoader.style.display = 'none';
                    mainContainer.style.display = 'block';
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
                    setTimeout(() => {
                        initIntegration();
                        initApp();
                    }, 300);
                }, 300);
            }, 500);
        }
    });
}
// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
function showRecoveryNotification(orderData) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 500;
      animation: fadeInOut 3s forwards;
    `;
    notification.innerHTML = `
      <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
      –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ #${orderData.orderId}
    `;
    document.body.appendChild(notification);
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏ –∏—Å—á–µ–∑–∞–Ω–∏—è
    setTimeout(() => {
        notification.style.animation = 'fadeOut 1s forwards';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            window.location.href = 'active-order.html';
        }, 1000);
    }, 2000);
}
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
async function checkActiveOrder() {
    const userData = JSON.parse(localStorage.getItem('tg_user'));
    if (!userData) return false;
    try {
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8004' 
            : 'https://taxibarsnz24.ru';
        const response = await fetch(`${API_BASE_URL}/api/web/user/${userData.id}/active-order`, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        const data = await response.json();
        if (data.success && data.order && data.order.status === 'accepted') {
            console.log('–ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑:', data.order);
            // üî• –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            let distanceKm = data.order.distance_km;
            let estimatedTime = data.order.estimated_time_min;
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ
            if (distanceKm === 0 || distanceKm === null || distanceKm === undefined) {
                const tempData = localStorage.getItem('last_order_data');
                if (tempData) {
                    try {
                        const parsedData = JSON.parse(tempData);
                        if (parsedData.distance_km && parsedData.distance_km > 0) {
                            distanceKm = parsedData.distance_km;
                            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è:', distanceKm);
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
                    }
                }
            }
            if (estimatedTime === "15 –º–∏–Ω—É—Ç" || estimatedTime === null || estimatedTime === undefined) {
                const tempData = localStorage.getItem('last_order_data');
                if (tempData) {
                    try {
                        const parsedData = JSON.parse(tempData);
                        if (parsedData.estimated_time_min && parsedData.estimated_time_min !== "15 –º–∏–Ω—É—Ç") {
                            estimatedTime = parsedData.estimated_time_min;
                            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏:', estimatedTime);
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–∏:', e);
                    }
                }
            }
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            const activeOrderData = {
                orderId: data.order.id,
                driverName: data.order.driver_name || '–í–æ–¥–∏—Ç–µ–ª—å',
                driverInitials: data.order.driver_name ? data.order.driver_name.charAt(0).toUpperCase() : '–í',
                driverId: data.order.driver_id,
                driverUsername: data.order.driver_username || null,
                carBrand: data.order.car_brand || '–ê–≤—Ç–æ–º–æ–±–∏–ª—å',
                carNumber: data.order.car_number || '',
                carYear: data.order.car_year || '2023',
                carColor: data.order.car_color || '–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π',
                pickupAddress: data.order.pickup_address,
                dropoffAddress: data.order.dropoff_address,
                price: data.order.price,
                distanceKm: distanceKm || 0,
                estimatedTime: estimatedTime || '15 –º–∏–Ω—É—Ç',
                passengers: data.order.passengers || 1,
                driverRating: parseFloat(data.order.driver_rating) || 4.8,
                status: data.order.status,
                createdAt: data.order.created_at,
                pickupCoordinates: data.order.pickup_coordinates,
                dropoffCoordinates: data.order.dropoff_coordinates,
                driverCoordinates: data.order.driver_coordinates
            };
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
            localStorage.setItem('activeOrderData', JSON.stringify(activeOrderData));
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
            showRecoveryNotification(activeOrderData);
            return true;
        }
        return false;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:', error);
        return false;
    }
}
  function clearAuthData() {
    localStorage.removeItem('tg_user');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('sessionExpiry');
    localStorage.removeItem('activeOrderData');
  }
  function logout() {
    clearAuthData();
    alert('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    window.location.href = 'login.html';
  }
  // ======================
  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
  // ======================
  function initApp() {
    const userData = JSON.parse(localStorage.getItem('tg_user'));
    if (userData) {
      document.querySelector('.profile-name').textContent = 
        userData.first_name + (userData.last_name ? ' ' + userData.last_name : '');
      document.querySelector('.profile-phone').textContent = 
        userData.username ? `@${userData.username}` : (userData.phone || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
      const mainAvatarImg = document.getElementById('userAvatar');
      const mainAvatarFallback = document.createElement('div');
      mainAvatarFallback.className = 'avatar-fallback';
      mainAvatarFallback.style.cssText = `
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #000 0%, #333 100%);
        color: white;
        font-weight: bold;
        border-radius: 50%;
        font-size: 16px;
      `;
      document.querySelector('.avatar').appendChild(mainAvatarFallback);
      if (userData.photo_url) {
        mainAvatarImg.src = userData.photo_url;
        mainAvatarImg.style.display = 'block';
        mainAvatarFallback.style.display = 'none';
      } else {
        const initials = userData.first_name.charAt(0) + (userData.last_name ? userData.last_name.charAt(0) : '');
        mainAvatarFallback.textContent = initials;
        mainAvatarImg.style.display = 'none';
        mainAvatarFallback.style.display = 'flex';
      }
    }
    document.querySelector('[data-action="logout"]').addEventListener('click', function() {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
      menuToggle.classList.remove('menu-open');
      logout();
    });
    setupEventListeners();
    setupMenu();
    setupPassengerSelection();
    setupQuickComments();
    setupCommentField();
    setupSwapAddresses();
    setupInputSelectAll();
    setupMarkerSetButtons();
    ymaps.ready(() => {
      initMap([56.013263, 90.417379]);
      getCurrentLocation()
        .then(coords => {
          currentLocation = coords;
          determineCity(coords).then(city => {
            currentUserCity = city;
            updateLocation(coords);
            updateQuickAddressSubtitles();
          });
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', error);
          currentUserCity = { name: '–ù–∞–∑–∞—Ä–æ–≤–æ', bounds: [[56.3823, 95.4500], [56.4023, 95.4700]] };
          updateQuickAddressSubtitles();
        });
    });
    setInterval(checkSessionExpiry, 60000);
    console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
  }
  function checkSessionExpiry() {
    const sessionExpiry = localStorage.getItem('sessionExpiry');
    if (sessionExpiry && Date.now() > parseInt(sessionExpiry)) {
      clearAuthData();
      window.location.href = 'login.html';
    }
  }
  // ======================
  // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –£–°–¢–ê–ù–û–í–ö–ò –ú–ê–†–ö–ï–†–ê
  // ======================
  let markerSetMode = null; // null, 'start' –∏–ª–∏ 'end'

  // ======================
  // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
  // ======================
  const CONFIG = {
    YANDEX_API_KEY: "d62a52d9-1485-41e8-a4af-439caa66c9e3",
    PRICE_PER_KM: {
      default: 35,
      moscow: 45,
      spb: 40,
      ekaterinburg: 38,
      krasnoyarsk: 32,
      novosibirsk: 36
    },
    EXTRA_PASSENGER_FEE: 50,
    MIN_PRICE: 150,
    DEBOUNCE_DELAY: 300
  };
  // ======================
  // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
  // ======================
  let ymap, route, isRouteCalculated = false, currentLocation = null, passengerCount = 1;
  let currentUserCity = { name: '–ù–∞–∑–∞—Ä–æ–≤–æ', bounds: [[56.3823, 95.4500], [56.4023, 95.4700]] };
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∞
  let isRouteReady = false;
  const quickAddresses = {
    home: localStorage.getItem('quickAddressHome') || '',
    work: localStorage.getItem('quickAddressWork') || ''
  };
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  let isProfileModalOpen = false;
  let isHistoryModalOpen = false;
  let isSearchModalOpen = false;
  let isDriverModalOpen = false;
  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const mapLoader = document.getElementById('mapLoader');
  const startInput = document.getElementById('startAddress');
  const endInput = document.getElementById('endAddress');
  const startInputFull = document.getElementById('startAddressFull');
  const endInputFull = document.getElementById('endAddressFull');
  const orderButton = document.getElementById('orderButton');
  const routeDetails = document.getElementById('routeDetails');
  const locationStatus = document.getElementById('locationStatus');
  const locationError = document.getElementById('locationError');
  const retryLocationBtn = document.getElementById('retryLocation');
  const passengerButtons = document.querySelectorAll('.passenger-btn');
  const quickComments = document.getElementById('quickComments');
  const commentInput = document.getElementById('orderComment');
  const commentTrigger = document.getElementById('commentTrigger');
  const calculatedValues = document.getElementById('calculated-values');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const menuToggle = document.getElementById('menuToggle');
  const swapAddressesBtn = document.getElementById('swapAddresses');
  const driverModal = document.getElementById('driverModal');
  const timerValue = document.getElementById('timerValue');
  const routeLoader = document.getElementById('routeLoader');
  const quickAddressesContainer = document.getElementById('quickAddresses');
  const addressEditContainer = document.getElementById('addressEditContainer');
  const addressEditInput = document.getElementById('addressEditInput');
  const addressEditSaveBtn = document.querySelector('.save-btn');
  const addressEditCancelBtn = document.querySelector('.cancel-btn');
  const currentLocationSubtitle = document.getElementById('current-location-subtitle');
  const homeSubtitle = document.getElementById('home-subtitle');
  const workSubtitle = document.getElementById('work-subtitle');
  const editTitleElement = document.getElementById('editTitle');
  const profileAvatar = document.getElementById('profileAvatar');
  const profileModal = document.getElementById('profileModal');
  const profileModalOverlay = document.getElementById('profileModalOverlay');
  const historyModal = document.getElementById('historyModal');
  const historyModalOverlay = document.getElementById('historyModalOverlay');
  const historyModalClose = document.getElementById('historyModalClose');
  const historyOrdersContainer = document.getElementById('historyOrdersContainer');
  // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞
  const searchDriverModal = document.getElementById('searchDriverModal');
  const searchDriverModalOverlay = document.getElementById('searchDriverModalOverlay');
  const searchTimerValue = document.getElementById('searchTimerValue');
  const cancelSearchBtn = document.getElementById('cancelSearchBtn');
  const markerSetIndicator = document.getElementById('markerSetIndicator');
  const setStartMarkerBtn = document.getElementById('setStartMarkerBtn');
  const setEndMarkerBtn = document.getElementById('setEndMarkerBtn');

  let driverTimerInterval = null;
  let timeLeft = 120;
  let startMarker, endMarker;
  let activeAddressInput = null;
  let editAddressType = null;
  let longPressTimer = null;
  let isLongPressActive = false;
  // ======================
  // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø API
  // ======================
  const API_BASE_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:8004' 
    : 'https://taxibarsnz24.ru';
  // ======================
  // –§–£–ù–ö–¶–ò–ò –ö–ê–†–¢–´ –ò –ê–î–†–ï–°–û–í
  // ======================
  function getCurrentLocation() {
    locationStatus.textContent = "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...";
    locationStatus.style.display = 'block';
    startInput.placeholder = "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...";
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const coords = [position.coords.latitude, position.coords.longitude];
          currentLocation = coords;
          locationStatus.style.display = 'none';
          resolve(coords);
        },
        (error) => {
          let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
          if (error.code === error.PERMISSION_DENIED) {
            msg = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
          } else if (error.code === error.TIMEOUT) {
            msg = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
          }
          locationStatus.style.display = 'none';
          reject(new Error(msg));
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }
  function showLocationError(error) {
    locationError.querySelector('div').textContent = error.message;
    locationError.style.display = 'block';
    startInput.placeholder = "–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
  }
  function retryLocation() {
    locationError.style.display = 'none';
    startInput.placeholder = "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...";
    startInput.value = "";
    getCurrentLocation()
      .then(coords => {
        if (ymap) updateLocation(coords);
      })
      .catch(error => {
        showLocationError(error);
      });
  }
  function updateLocation(coords) {
    if (!startMarker) return;
    startMarker.geometry.setCoordinates(coords);
    ymap.setCenter(coords, 15);
    ymaps.geocode(coords, { results: 1 }).then(res => {
      const geoObject = res.geoObjects.get(0);
      if (geoObject) {
        const fullAddress = geoObject.getAddressLine();
        startInputFull.value = fullAddress;
        startInput.value = fullAddress;
        determineCity(coords).then(city => {
          currentUserCity = city;
        });
      }
    }).catch(error => {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
    });
  }
  function determineCity(coords) {
    return new Promise((resolve) => {
      ymaps.geocode(coords, { results: 1 }).then(res => {
        const geoObject = res.geoObjects.get(0);
        if (geoObject) {
          const addr = geoObject.getAddressLine().toLowerCase();
          const [lat, lng] = coords;
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
          if (addr.includes('—É–∂—É—Ä')) {
            resolve({ 
              name: '–£–∂—É—Ä', 
              bounds: [[55.9700, 89.8100], [56.0700, 89.9100]],
              center: [56.0200, 89.8600]
            });
          } else if (addr.includes('–∞—á–∏–Ω—Å–∫')) {
            resolve({ 
              name: '–ê—á–∏–Ω—Å–∫', 
              bounds: [[56.1600, 94.1600], [56.2600, 94.2600]],
              center: [56.2100, 94.2100]
            });
          } else if (addr.includes('–º–∏–Ω—É—Å–∏–Ω—Å–∫')) {
            resolve({ 
              name: '–ú–∏–Ω—É—Å–∏–Ω—Å–∫', 
              bounds: [[53.6800, 91.6500], [53.7800, 91.7500]],
              center: [53.7300, 91.6900]
            });
          } else if (addr.includes('–∫—É—Ä–∞–≥–∏–Ω–æ')) {
            resolve({ 
              name: '–ö—É—Ä–∞–≥–∏–Ω–æ', 
              bounds: [[54.0100, 92.8600], [54.1100, 92.9600]],
              center: [54.0600, 92.9100]
            });
          } else if (addr.includes('—à–∞—Ä—ã–ø–æ–≤–æ')) {
            resolve({ 
              name: '–®–∞—Ä—ã–ø–æ–≤–æ', 
              bounds: [[55.4000, 91.8900], [55.5000, 91.9900]],
              center: [55.4500, 91.9400]
            });
          } else if (addr.includes('–∞–±–∞–Ω')) {
            resolve({ 
              name: '–ê–±–∞–Ω', 
              bounds: [[54.6900, 96.2100], [54.7900, 96.3100]],
              center: [54.7400, 96.2600]
            });
          } else if (addr.includes('–±–∞–ª–∞—Ö—Ç–∞')) {
            resolve({ 
              name: '–ë–∞–ª–∞—Ö—Ç–∞', 
              bounds: [[55.0800, 93.9800], [55.1800, 94.0800]],
              center: [55.1300, 94.0300]
            });
          } else if (addr.includes('–Ω–∞–∑–∞—Ä–æ–≤–æ') || addr.includes('–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫')) {
            resolve({ 
              name: '–ù–∞–∑–∞—Ä–æ–≤–æ', 
              bounds: [[56.3823, 95.4500], [56.4023, 95.4700]],
              center: [56.3923, 95.4600]
            });
          } else if (addr.includes('–º–æ—Å–∫–≤–∞')) {
            resolve({ 
              name: '–ú–æ—Å–∫–≤–∞', 
              bounds: [[55.4892, 37.3193], [55.9892, 37.9193]],
              center: [55.7558, 37.6173]
            });
          } else if (addr.includes('—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥') || addr.includes('—Å–ø–±')) {
            resolve({ 
              name: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', 
              bounds: [[59.5576, 30.0063], [60.1304, 30.6616]],
              center: [59.9343, 30.3351]
            });
          } else if (addr.includes('–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥')) {
            resolve({ 
              name: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', 
              bounds: [[56.6437, 60.2811], [56.9437, 60.5811]],
              center: [56.8519, 60.6122]
            });
          } else if (addr.includes('–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫')) {
            resolve({ 
              name: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', 
              bounds: [[54.7983, 82.8762], [55.0983, 83.1762]],
              center: [54.9887, 82.9034]
            });
          } 
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ—Ä–æ–¥ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –¥–ª—è –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è
          else if (lat > 55.8 && lat < 56.2 && lng > 89.5 && lng < 90.5) {
            resolve({ 
              name: '–£–∂—É—Ä', 
              bounds: [[55.9700, 89.8100], [56.0700, 89.9100]],
              center: [56.0200, 89.8600]
            });
          } else if (lat > 56.1 && lat < 56.3 && lng > 94.0 && lng < 94.4) {
            resolve({ 
              name: '–ê—á–∏–Ω—Å–∫', 
              bounds: [[56.1600, 94.1600], [56.2600, 94.2600]],
              center: [56.2100, 94.2100]
            });
          } else if (lat > 53.6 && lat < 53.8 && lng > 91.6 && lng < 91.8) {
            resolve({ 
              name: '–ú–∏–Ω—É—Å–∏–Ω—Å–∫', 
              bounds: [[53.6800, 91.6500], [53.7800, 91.7500]],
              center: [53.7300, 91.6900]
            });
          } else if (lat > 56.3 && lat < 56.5 && lng > 95.3 && lng < 95.6) {
            resolve({ 
              name: '–ù–∞–∑–∞—Ä–æ–≤–æ', 
              bounds: [[56.3823, 95.4500], [56.4023, 95.4700]],
              center: [56.3923, 95.4600]
            });
          } else {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ù–∞–∑–∞—Ä–æ–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            resolve({ 
              name: '–ù–∞–∑–∞—Ä–æ–≤–æ', 
              bounds: [[56.3823, 95.4500], [56.4023, 95.4700]],
              center: [56.3923, 95.4600]
            });
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–æ–±—ä–µ–∫—Ç
          resolve({ 
            name: '–ù–∞–∑–∞—Ä–æ–≤–æ', 
            bounds: [[56.3823, 95.4500], [56.4023, 95.4700]],
            center: [56.3923, 95.4600]
          });
        }
      }).catch(() => {
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        resolve({ 
          name: '–ù–∞–∑–∞—Ä–æ–≤–æ', 
          bounds: [[56.3823, 95.4500], [56.4023, 95.4700]],
          center: [56.3923, 95.4600]
        });
      });
    });
  }
  function initMap(initialCoords) {
    try {
      mapLoader.style.opacity = '0';
      setTimeout(() => mapLoader.style.display = 'none', 300);
      ymap = new ymaps.Map('map', {
        center: initialCoords,
        zoom: 15,
        controls: ['zoomControl']
      }, { suppressMapOpenBlock: true });
      startMarker = new ymaps.Placemark(initialCoords, { hintContent: '–ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞' }, {
        preset: 'islands#blackCircleDotIconWithCaption',
        iconColor: '#000'
      });
      endMarker = new ymaps.Placemark(initialCoords, { hintContent: '–ö–æ–Ω–µ—Ü –º–∞—Ä—à—Ä—É—Ç–∞' }, {
        preset: 'islands#redCircleDotIconWithCaption',
        iconColor: '#FF0000'
      });
      ymap.geoObjects.add(startMarker);
      ymap.geoObjects.add(endMarker);
      startMarker.events.add('dragend', (e) => {
        const coords = startMarker.geometry.getCoordinates();
        getAddressFromCoords(coords, 'start', true);
      });
      endMarker.events.add('dragend', (e) => {
        const coords = endMarker.geometry.getCoordinates();
        getAddressFromCoords(coords, 'end', true);
      });
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–∞
      ymap.events.add('click', function(e) {
        if (markerSetMode) {
          e.preventDefault();
          const coords = e.get('coords');
          
          if (markerSetMode === 'start') {
            startMarker.geometry.setCoordinates(coords);
            getAddressFromCoords(coords, 'start', true);
          } else {
            endMarker.geometry.setCoordinates(coords);
            getAddressFromCoords(coords, 'end', true);
          }
          
          deactivateMarkerSetMode();
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      ymap.events.add('touchstart', function(e) {
        if (markerSetMode) {
          e.preventDefault();
          const coords = e.get('coords');
          
          if (markerSetMode === 'start') {
            startMarker.geometry.setCoordinates(coords);
            getAddressFromCoords(coords, 'start', true);
          } else {
            endMarker.geometry.setCoordinates(coords);
            getAddressFromCoords(coords, 'end', true);
          }
          
          deactivateMarkerSetMode();
        }
      });
      if (currentLocation) updateLocation(currentLocation);
      updateQuickAddressSubtitles();
      setupAddressAutocomplete();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
      mapLoader.innerHTML = `<div style="color: var(--error-color); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</div>`;
    }
  }
  function getAddressFromCoords(coords, type, recalc = false) {
    ymaps.geocode(coords, { results: 1 }).then(res => {
      const geoObject = res.geoObjects.get(0);
      if (geoObject) {
        const fullAddr = geoObject.getAddressLine();
        const input = type === 'start' ? startInput : endInput;
        const inputFull = type === 'start' ? startInputFull : endInputFull;
        inputFull.value = fullAddr;
        input.value = fullAddr;
        if (recalc) calculateRoute();
      }
    }).catch(error => console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:`, error));
  }
  function getCurrentCity() {
    let addr = startInputFull.value.toLowerCase() || startInput.value.toLowerCase();
    if (addr.includes('—É–∂—É—Ä')) return 'krasnoyarsk';
    if (addr.includes('–∞—á–∏–Ω—Å–∫')) return 'krasnoyarsk';
    if (addr.includes('–º–∏–Ω—É—Å–∏–Ω—Å–∫')) return 'krasnoyarsk';
    if (addr.includes('–∫—É—Ä–∞–≥–∏–Ω–æ')) return 'krasnoyarsk';
    if (addr.includes('—à–∞—Ä—ã–ø–æ–≤–æ')) return 'krasnoyarsk';
    if (addr.includes('–Ω–∞–∑–∞—Ä–æ–≤–æ') || addr.includes('–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫')) return 'krasnoyarsk';
    if (addr.includes('–º–æ—Å–∫–≤–∞')) return 'moscow';
    if (addr.includes('—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥') || addr.includes('—Å–ø–±')) return 'spb';
    if (addr.includes('–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥')) return 'ekaterinburg';
    if (addr.includes('–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫')) return 'novosibirsk';
    return 'default';
  }
  function clearRoute() {
    if (route) {
      ymap.geoObjects.remove(route);
      route = null;
    }
    document.getElementById('priceDisplay').textContent = '‚Äî ‚ÇΩ';
    document.getElementById('distanceDisplay').textContent = '‚Äî –∫–º';
    document.getElementById('estimatedTime').textContent = '–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è';
    routeDetails.style.display = 'none';
    document.querySelector('.price-placeholder').style.display = 'block';
    document.querySelector('.distance-placeholder').style.display = 'block';
    isRouteCalculated = false;
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    isRouteReady = false;
    orderButton.disabled = true;
  }
  function showError(message) {
    alert(`–û—à–∏–±–∫–∞: ${message}`);
    clearRoute();
  }
  function setupAddressAutocomplete() {
    startInput.addEventListener('focus', () => { activeAddressInput = 'start'; showQuickAddresses(); });
    endInput.addEventListener('focus', () => { activeAddressInput = 'end'; showQuickAddresses(); });
    startInput.addEventListener('blur', () => {
      setTimeout(() => { if (startInput.value.trim() && endInput.value.trim()) calculateRoute(); }, 200);
    });
    endInput.addEventListener('blur', () => {
      setTimeout(() => { if (startInput.value.trim() && endInput.value.trim()) calculateRoute(); }, 200);
    });
    startInput.addEventListener('change', () => {
      if (startInput.value.trim()) geocodeAddress(startInput.value, 'start');
    });
    endInput.addEventListener('change', () => {
      if (endInput.value.trim()) geocodeAddress(endInput.value, 'end');
    });
    startInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && startInput.value.trim() && endInput.value.trim()) {
        e.preventDefault();
        calculateRoute();
      }
    });
    endInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && startInput.value.trim() && endInput.value.trim()) {
        e.preventDefault();
        calculateRoute();
      }
    });
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏ –≤–≤–æ–¥–µ –∞–¥—Ä–µ—Å–∞ –≤—Ä—É—á–Ω—É—é
    startInput.addEventListener('input', function() {
      if (markerSetMode === 'start') {
        deactivateMarkerSetMode();
      }
    });
    
    endInput.addEventListener('input', function() {
      if (markerSetMode === 'end') {
        deactivateMarkerSetMode();
      }
    });
    document.querySelectorAll('.quick-address-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (isLongPressActive) return;
        const addressType = item.getAttribute('data-address');
        handleQuickAddress(addressType);
      });
      const addressType = item.getAttribute('data-address');
      if (addressType === 'home' || addressType === 'work') {
        const handleLongPress = () => {
          isLongPressActive = true;
          showAddressEditModal(addressType);
        };
        item.addEventListener('mousedown', () => longPressTimer = setTimeout(handleLongPress, 500));
        item.addEventListener('mouseup', () => { if (longPressTimer) clearTimeout(longPressTimer); });
        item.addEventListener('mouseleave', () => { if (longPressTimer) clearTimeout(longPressTimer); });
        item.addEventListener('touchstart', () => longPressTimer = setTimeout(handleLongPress, 500));
        item.addEventListener('touchend', () => { if (longPressTimer) clearTimeout(longPressTimer); });
        item.addEventListener('touchcancel', () => { if (longPressTimer) clearTimeout(longPressTimer); });
      }
    });
    addressEditSaveBtn.addEventListener('click', saveEditedAddress);
    addressEditCancelBtn.addEventListener('click', () => {
      addressEditContainer.style.display = 'none';
      editAddressType = null;
      isLongPressActive = false;
      quickAddressesContainer.style.display = 'block';
    });
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—ã—Å—Ç—Ä—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
    document.addEventListener('click', function(e) {
      if (!quickAddressesContainer.contains(e.target) && 
          !startInput.contains(e.target) && 
          !endInput.contains(e.target) &&
          quickAddressesContainer.style.display === 'block') {
        quickAddressesContainer.style.display = 'none';
        addressEditContainer.style.display = 'none';
      }
    });
  }
  function updateQuickAddressSubtitles() {
    if (currentLocation) {
      ymaps.geocode(currentLocation, { results: 1 }).then(res => {
        const geoObject = res.geoObjects.get(0);
        if (geoObject) {
          currentLocationSubtitle.textContent = geoObject.getAddressLine();
        } else {
          currentLocationSubtitle.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å';
        }
      }).catch(() => currentLocationSubtitle.textContent = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
    } else {
      getCurrentLocation().then(coords => {
        currentLocation = coords;
        updateQuickAddressSubtitles();
      }).catch(() => currentLocationSubtitle.textContent = '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ');
    }
    homeSubtitle.textContent = quickAddresses.home || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    workSubtitle.textContent = quickAddresses.work || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
  }
  function showQuickAddresses() {
    quickAddressesContainer.style.display = 'block';
    addressEditContainer.style.display = 'none';
    updateQuickAddressSubtitles();
  }
  function handleQuickAddress(addressType) {
    if (addressType === 'current-location') {
      if (!currentLocation) {
        locationStatus.textContent = "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...";
        locationStatus.style.display = 'block';
        getCurrentLocation()
          .then(coords => {
            currentLocation = coords;
            locationStatus.style.display = 'none';
            getAddressFromCoords(currentLocation, activeAddressInput, true);
            quickAddressesContainer.style.display = 'none';
          })
          .catch(error => {
            locationStatus.style.display = 'none';
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + error.message);
            quickAddressesContainer.style.display = 'none';
          });
      } else {
        getAddressFromCoords(currentLocation, activeAddressInput, true);
        quickAddressesContainer.style.display = 'none';
      }
    } else if (addressType === 'home' || addressType === 'work') {
      if (quickAddresses[addressType]?.trim()) {
        const input = activeAddressInput === 'start' ? startInput : endInput;
        const inputFull = activeAddressInput === 'start' ? startInputFull : endInputFull;
        inputFull.value = quickAddresses[addressType];
        input.value = quickAddresses[addressType];
        geocodeAddress(quickAddresses[addressType], activeAddressInput);
        quickAddressesContainer.style.display = 'none';
      } else {
        showAddressEditModal(addressType);
      }
    }
    isLongPressActive = false;
  }
  function showAddressEditModal(addressType) {
    editAddressType = addressType;
    addressEditInput.value = quickAddresses[addressType] || '';
    if (addressType === 'home') {
      editTitleElement.textContent = '–ê–¥—Ä–µ—Å –¥–æ–º–∞';
      addressEditInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ–º–∞';
    } else if (addressType === 'work') {
      editTitleElement.textContent = '–ê–¥—Ä–µ—Å —Ä–∞–±–æ—Ç—ã';
      addressEditInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Ä–∞–±–æ—Ç—ã';
    }
    addressEditContainer.style.display = 'block';
    quickAddressesContainer.style.display = 'block';
    setTimeout(() => addressEditInput.focus(), 100);
  }
  function saveEditedAddress() {
    const address = addressEditInput.value.trim();
    if (address) {
      quickAddresses[editAddressType] = address;
      localStorage.setItem(`quickAddress${editAddressType.charAt(0).toUpperCase() + editAddressType.slice(1)}`, address);
      const input = activeAddressInput === 'start' ? startInput : endInput;
      const inputFull = activeAddressInput === 'start' ? startInputFull : endInputFull;
      inputFull.value = address;
      input.value = address;
      geocodeAddress(address, activeAddressInput);
      addressEditContainer.style.display = 'none';
      editAddressType = null;
      isLongPressActive = false;
      updateQuickAddressSubtitles();
    }
  }
  function setupPassengerSelection() {
    passengerButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        passengerButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        passengerCount = parseInt(btn.getAttribute('data-passengers'));
        if (isRouteCalculated) calculateRoute();
      });
    });
  }
  function setupQuickComments() {
    document.querySelectorAll('.quick-comment-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const commentText = btn.getAttribute('data-comment');
        if (!commentInput.classList.contains('active')) {
          commentInput.classList.add('active');
          quickComments.classList.add('active');
        }
        if (commentInput.value.trim() === '') commentInput.value = commentText;
        else commentInput.value += '\n' + commentText;
        commentInput.scrollTop = commentInput.scrollHeight;
        btn.classList.add('active');
        setTimeout(() => btn.classList.remove('active'), 300);
      });
    });
  }
  function setupCommentField() {
    commentTrigger.addEventListener('click', () => {
      commentInput.classList.add('active');
      quickComments.classList.add('active');
      commentInput.focus();
    });
    document.addEventListener('click', (e) => {
      if (!commentInput.contains(e.target) && !commentTrigger.contains(e.target) && !quickComments.contains(e.target)) {
        quickComments.classList.remove('active');
        if (commentInput.value.trim() === '') commentInput.classList.remove('active');
      }
    });
    commentInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        quickComments.classList.remove('active');
        if (commentInput.value.trim() === '') commentInput.classList.remove('active');
        commentInput.blur();
      }
    });
  }
  function setupMenu() {
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
      menuToggle.classList.toggle('menu-open');
    });
    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
      menuToggle.classList.remove('menu-open');
    });
    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const action = item.getAttribute('data-action');
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        menuToggle.classList.remove('menu-open');
        if (action === 'support') {
          alert('–ü–æ–¥–¥–µ—Ä–∂–∫–∞: +7 (495) 123-45-67\nsupport@vash-taxi.ru');
        }
        if (action === 'history') {
          showHistoryModal();
        }
      });
    });
  }
  function setupSwapAddresses() {
    swapAddressesBtn.addEventListener('click', () => {
      const startValue = startInput.value;
      const startFullValue = startInputFull.value;
      const endValue = endInput.value;
      const endFullValue = endInputFull.value;
      const startCoords = startMarker.geometry.getCoordinates();
      const endCoords = endMarker.geometry.getCoordinates();
      startInput.value = endValue;
      startInputFull.value = endFullValue;
      endInput.value = startValue;
      endInputFull.value = startFullValue;
      startMarker.geometry.setCoordinates(endCoords);
      endMarker.geometry.setCoordinates(startCoords);
      setTimeout(() => ymap.setBounds(ymap.geoObjects.getBounds(), {checkZoomRange: true}), 100);
      if (startFullValue && endFullValue) calculateRoute();
      swapAddressesBtn.style.transform = 'scale(1.2)';
      setTimeout(() => swapAddressesBtn.style.transform = 'scale(1)', 200);
    });
  }
  function setupInputSelectAll() {
    startInput.addEventListener('focus', function() { if (this.value) this.select(); });
    endInput.addEventListener('focus', function() { if (this.value) this.select(); });
  }
  // ======================
  // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–°–¢–ê–ù–û–í–ö–ò –ú–ê–†–ö–ï–†–ê
  // ======================
  function setupMarkerSetButtons() {
    if (setStartMarkerBtn && setEndMarkerBtn) {
      setStartMarkerBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        activateMarkerSetMode('start');
      });
      
      setEndMarkerBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        activateMarkerSetMode('end');
      });
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Esc
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && markerSetMode) {
          deactivateMarkerSetMode();
        }
      });
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–∞—Ä—Ç—ã
      document.addEventListener('click', function(e) {
        if (markerSetMode && 
            !e.target.closest('#map') && 
            !e.target.closest('.marker-set-btn') &&
            !e.target.closest('.marker-set-indicator')) {
          deactivateMarkerSetMode();
        }
      });
    }
  }

  function activateMarkerSetMode(mode) {
    markerSetMode = mode;
    document.body.classList.add('marker-set-mode');
    
    let message = '';
    if (mode === 'start') {
      message = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ';
    } else {
      message = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ';
    }
    
    if (markerSetIndicator) {
      markerSetIndicator.textContent = message;
      markerSetIndicator.style.display = 'block';
      markerSetIndicator.style.animation = 'fadeIn 0.3s ease';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ —Ä–µ–∂–∏–º –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
    setTimeout(() => {
      if (markerSetMode === mode && markerSetIndicator) {
        markerSetIndicator.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => {
          if (markerSetMode === mode) {
            markerSetIndicator.style.display = 'none';
          }
        }, 300);
      }
    }, 5000);
  }

  function deactivateMarkerSetMode() {
    markerSetMode = null;
    document.body.classList.remove('marker-set-mode');
    
    if (markerSetIndicator) {
      markerSetIndicator.style.animation = 'fadeOut 0.3s forwards';
      setTimeout(() => {
        markerSetIndicator.style.display = 'none';
      }, 300);
    }
  }
  // ======================
  // –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø GEOCODEADDRESS
  // ======================
  function geocodeAddress(address, type) {
    ymaps.geocode(address, { results: 1, boundedBy: currentUserCity.bounds }).then(res => {
      const geoObject = res.geoObjects.get(0);
      if (geoObject) {
        const coords = geoObject.geometry.getCoordinates();
        if (type === 'start') { 
          startMarker.geometry.setCoordinates(coords); 
          ymap.setCenter(coords, 15); 
        } else {
          endMarker.geometry.setCoordinates(coords);
          setTimeout(() => {
            ymap.setBounds(ymap.geoObjects.getBounds(), {checkZoomRange: true});
          }, 100);
        }
        const input = type === 'start' ? startInput : endInput;
        const inputFull = type === 'start' ? startInputFull : endInputFull;
        const fullAddress = geoObject.getAddressLine();
        inputFull.value = fullAddress;
        input.value = fullAddress;
        calculateRoute();
      }
    }).catch(error => {
      console.error(`–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ ${address}:`, error);
    });
  }
  // ======================
  // –§–£–ù–ö–¶–ò–ò –ú–ê–†–®–†–£–¢–ê
  // ======================
  function calculateRoute() {
    const start = startInputFull.value.trim();
    const end = endInputFull.value.trim();
    orderButton.disabled = true;
    isRouteReady = false;
    if (!start || !end) {
      clearRoute();
      return;
    }
    routeLoader.classList.add('active');
    try {
      const multiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: [startMarker.geometry.getCoordinates(), endMarker.geometry.getCoordinates()],
        params: { routingMode: "auto" }
      }, { 
        boundsAutoApply: true,
        zoomMargin: 30
      });
      if (route) ymap.geoObjects.remove(route);
      ymap.geoObjects.add(multiRoute);
      route = multiRoute;
      multiRoute.model.events.once('requestsuccess', () => {
        const activeRoute = multiRoute.getActiveRoute();
        if (activeRoute && activeRoute.properties.get("distance")) {
          updateRouteInfo(activeRoute);
          isRouteCalculated = true;
          orderButton.disabled = false;
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥
          fallbackRouteCalculation();
          orderButton.disabled = true;
        }
        routeLoader.classList.remove('active');
      });
      multiRoute.model.events.once('requestfail', () => {
        // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π
        fallbackRouteCalculation();
        orderButton.disabled = true;
        routeLoader.classList.remove('active');
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
      fallbackRouteCalculation();
      routeLoader.classList.remove('active');
    }
  }
  // –†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
  function fallbackRouteCalculation() {
    const startCoords = startMarker.geometry.getCoordinates();
    const endCoords = endMarker.geometry.getCoordinates();
    // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
    const distance = ymaps.coordSystem.geo.getDistance(startCoords, endCoords) / 1000;
    const duration = Math.max(15, Math.round(distance / 50 * 60)); // –ü—Ä–∏–º–µ—Ä–Ω–æ 50 –∫–º/—á
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
    updateFallbackRouteInfo(distance, duration);
    isRouteCalculated = true;
    orderButton.disabled = false;
  }
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —Ä–∞—Å—á–µ—Ç–µ
  function updateFallbackRouteInfo(distance, duration) {
    // –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç: duration –≤—Å–µ–≥–¥–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
    const durationMinutes = parseDurationToMinutes(duration.toString());
    const durationText = `${durationMinutes} –º–∏–Ω`;
    const trafficMsg = `–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${durationText}`;
    routeDetails.textContent = trafficMsg;
    routeDetails.className = 'route-details info';
    routeDetails.style.display = 'block';
    const city = getCurrentCity();
    const pricePerKm = CONFIG.PRICE_PER_KM[city] || CONFIG.PRICE_PER_KM.default;
    let basePrice = distance * pricePerKm;
    const extraPassengers = Math.max(0, passengerCount - 1);
    const extraFee = extraPassengers * CONFIG.EXTRA_PASSENGER_FEE;
    let totalPrice = basePrice + extraFee;
    if (totalPrice < CONFIG.MIN_PRICE) totalPrice = CONFIG.MIN_PRICE;
    document.querySelector('.price-placeholder').style.display = 'none';
    document.querySelector('.distance-placeholder').style.display = 'none';
    calculatedValues.style.display = 'block';
    document.getElementById('priceDisplay').textContent = `${Math.round(totalPrice)} ‚ÇΩ`;
    document.getElementById('distanceDisplay').textContent = `${distance.toFixed(1)} –∫–º`;
    document.getElementById('estimatedTime').textContent = durationText;
    isRouteReady = true;
}
  function updateRouteInfo(activeRoute) {
    const distance = (activeRoute.properties.get("distance").value / 1000).toFixed(1);
    const duration = activeRoute.properties.get("duration").text;
    const trafficLevel = getTrafficLevel(activeRoute);
    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—É—Ç–∏
    let durationMinutes = parseDurationToMinutes(duration);
    let durationText = `${durationMinutes} –º–∏–Ω`;
    let trafficMsg = `–ü—Ä–æ–±–∫–∏: —É–º–µ—Ä–µ–Ω–Ω—ã–µ ‚Ä¢ –í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${durationText}`;
    if (trafficLevel === 'low') {
        trafficMsg = `–ü—Ä–æ–±–∫–∏: –Ω–∏–∑–∫–∏–µ ‚Ä¢ –í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${durationText}`;
    } else if (trafficLevel === 'heavy') {
        const timeWithoutTraffic = Math.max(1, Math.round(durationMinutes * 0.7));
        trafficMsg = `–ü—Ä–æ–±–∫–∏: –≤—ã—Å–æ–∫–∏–µ ‚Ä¢ –í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${durationText} (–±–µ–∑ –ø—Ä–æ–±–æ–∫: ${timeWithoutTraffic} –º–∏–Ω)`;
    }
    routeDetails.textContent = trafficMsg;
    routeDetails.className = 'route-details info';
    routeDetails.style.display = 'block';
    const city = getCurrentCity();
    const pricePerKm = CONFIG.PRICE_PER_KM[city] || CONFIG.PRICE_PER_KM.default;
    let basePrice = distance * pricePerKm;
    const extraPassengers = Math.max(0, passengerCount - 1);
    const extraFee = extraPassengers * CONFIG.EXTRA_PASSENGER_FEE;
    let totalPrice = basePrice + extraFee;
    if (totalPrice < CONFIG.MIN_PRICE) totalPrice = CONFIG.MIN_PRICE;
    document.querySelector('.price-placeholder').style.display = 'none';
    document.querySelector('.distance-placeholder').style.display = 'none';
    calculatedValues.style.display = 'block';
    document.getElementById('priceDisplay').textContent = `${Math.round(totalPrice)} ‚ÇΩ`;
    document.getElementById('distanceDisplay').textContent = `${distance} –∫–º`;
    document.getElementById('estimatedTime').textContent = durationText;
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –≥–æ—Ç–æ–≤
    isRouteReady = true;
}
function parseDurationToMinutes(durationText) {
    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤ –º–∏–Ω—É—Ç—ã
    if (!durationText) return 15;
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "–º–∏–Ω", –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ
    const minutesMatch = durationText.match(/(\d+)\s*–º–∏–Ω/);
    if (minutesMatch) {
        return parseInt(minutesMatch[1], 10);
    }
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
    const hoursMinutesMatch = durationText.match(/(\d+)\s*—á\s*(\d+)\s*–º–∏–Ω/);
    if (hoursMinutesMatch) {
        const hours = parseInt(hoursMinutesMatch[1], 10);
        const minutes = parseInt(hoursMinutesMatch[2], 10);
        return hours * 60 + minutes;
    }
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å—ã
    const hoursMatch = durationText.match(/(\d+)\s*—á/);
    if (hoursMatch) {
        return parseInt(hoursMatch[1], 10) * 60;
    }
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –º–∏–Ω—É—Ç—ã
    const numberMatch = durationText.match(/(\d+)/);
    if (numberMatch) {
        return parseInt(numberMatch[1], 10);
    }
    return 15;
}
function getTrafficLevel(route) {
    const distance = route.properties.get("distance").value / 1000;
    const durationValue = parseFloat(route.properties.get("duration").text);
    const avgSpeed = distance / (durationValue / 60); // –∫–º/—á
    if (avgSpeed > 45) return 'low';    // –°–≤–æ–±–æ–¥–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
    if (avgSpeed > 25) return 'moderate'; // –£–º–µ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–∫–∏
    return 'heavy';                     // –°–∏–ª—å–Ω—ã–µ –ø—Ä–æ–±–∫–∏
}
  function getTrafficLevel(route) {
    const distance = route.properties.get("distance").value / 1000;
    const durationValue = parseFloat(route.properties.get("duration").text);
    if (durationValue < 5) return 'low';
    if (distance > 10 && durationValue / distance > 1.5) return 'heavy';
    if (distance > 5 && durationValue / distance > 1.2) return 'moderate';
    return 'low';
  }
  // ======================
  // –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ü–û–ò–°–ö–ê –í–û–î–ò–¢–ï–õ–Ø
  // ======================
  function showSearchDriverModal(orderId, orderData) {
  if (isSearchModalOpen) return;
  isSearchModalOpen = true;
  searchDriverModalOverlay.classList.add('active');
  searchDriverModal.classList.add('active');
  document.body.style.overflow = 'hidden';
  let timeLeft = 180; // 3 –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  searchTimerValue.textContent = '03:00';
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
  const searchTimer = setInterval(() => {
    timeLeft--;
    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = (timeLeft % 60).toString().padStart(2, '0');
    searchTimerValue.textContent = `${m}:${s}`;
    if (timeLeft <= 0) {
      clearInterval(searchTimer);
      closeSearchDriverModal();
      showCancelScreen();
    }
  }, 1000);
  // –ò–∑–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
  cancelSearchBtn.onclick = () => {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const confirmModal = document.createElement('div');
    confirmModal.className = 'search-cancel-modal';
    confirmModal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      displayed: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;
    confirmModal.innerHTML = `
      <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative;">
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #212121;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã</h3>
        <p style="font-size: 16px; color: #616161; margin-bottom: 24px; line-height: 1.5;">
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –≤–æ–¥–∏—Ç–µ–ª—è?
        </p>
        <div style="display: flex; gap: 12px;">
          <button class="cancel-confirm-btn" style="flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #d9d9d9; background: #f8f9fa; color: #212121; font-weight: 500; cursor: pointer;">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button class="confirm-btn" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: #d32f2f; color: white; font-weight: 500; cursor: pointer;">
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmModal);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    confirmModal.querySelector('.cancel-confirm-btn').addEventListener('click', () => {
      document.body.removeChild(confirmModal);
    });
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    confirmModal.querySelector('.confirm-btn').addEventListener('click', () => {
      document.body.removeChild(confirmModal);
      clearInterval(searchTimer);
      closeSearchDriverModal();
      cancelOrder(orderId);
    });
  };
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –æ—Ç–∫–ª–∏–∫–æ–≤ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    let hasReceivedFirstBid = false;
    const pollBidsForSearch = async () => {
      try {
        const res = await fetch(`${API_BASE_URL}/api/web/order/${orderId}/bids`);
        if (!res.ok) throw new Error(`${res.status}`);
        const data = await res.json();
        if (data.success && data.bids?.length > 0 && !hasReceivedFirstBid) {
          hasReceivedFirstBid = true;
          clearInterval(searchTimer);
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
          closeSearchDriverModal();
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–ª–æ—Å—å
          setTimeout(() => {
            showDriverModalForWeb(orderId, orderData);
          }, 300);
        } else {
          setTimeout(pollBidsForSearch, 2000);
        }
      } catch (e) {
        console.error('Poll bids error:', e);
        setTimeout(pollBidsForSearch, 3000);
      }
    };
    pollBidsForSearch();
  }
  function closeSearchDriverModal() {
    if (!isSearchModalOpen) return;
    isSearchModalOpen = false;
    searchDriverModalOverlay.classList.remove('active');
    searchDriverModal.classList.remove('active');
    document.body.style.overflow = 'auto';
  }
  function closeDriverModal() {
    if (!isDriverModalOpen) return;
    isDriverModalOpen = false;
    driverModal.classList.remove('active');
    document.body.style.overflow = 'auto';
    if (driverTimerInterval) {
      clearInterval(driverTimerInterval);
      driverTimerInterval = null;
    }
  }
  async function cancelOrder(orderId) {
    try {
      const loader = document.getElementById('routeLoader');
      loader.classList.add('active');
      loader.textContent = '–û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞...';
      loader.style.display = 'block';
      const res = await fetch(`${API_BASE_URL}/api/web/order/${orderId}/cancel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: 'client_canceled' })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(`–°–µ—Ä–≤–µ—Ä: ${res.status} ${err.detail || res.statusText}`);
      }
      const result = await res.json();
      if (!result.success) {
        throw new Error(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞');
      }
      // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      window.location.href = 'main.html';
    } catch (err) {
      console.error('Cancel order failed:', err);
      alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
      const loader = document.getElementById('routeLoader');
      loader.classList.remove('active');
      loader.style.display = 'none';
    }
  }
  // ======================
  // –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –í–´–ë–û–†–ê –í–û–î–ò–¢–ï–õ–ï–ô
  // ======================
  function showDriverModalForWeb(orderId, orderData) {
    if (isDriverModalOpen) return;
    isDriverModalOpen = true;
    driverModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    let timeLeft = 120;
    const timerEl = document.getElementById('timerValue');
    timerEl.textContent = '02:00';
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (driverTimerInterval) clearInterval(driverTimerInterval);
    driverTimerInterval = setInterval(() => {
      timeLeft--;
      const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
      const s = (timeLeft % 60).toString().padStart(2, '0');
      timerEl.textContent = `${m}:${s}`;
      if (timeLeft <= 0) {
        clearInterval(driverTimerInterval);
        closeDriverModal();
        showCancelScreen();
      }
    }, 1000);
    // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç–∫–ª–∏–∫–æ–≤ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    const pollBids = async () => {
      try {
        const res = await fetch(`${API_BASE_URL}/api/web/order/${orderId}/bids`);
        if (!res.ok) throw new Error(`${res.status}`);
        const data = await res.json();
        if (data.success && data.bids?.length) {
          renderDriverBids(data.bids, orderId, orderData);
        }
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–∫–∞ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        if (isDriverModalOpen) {
          setTimeout(pollBids, 2000);
        }
      } catch (e) {
        console.error('Poll bids error:', e);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (isDriverModalOpen) {
          setTimeout(pollBids, 3000);
        }
      }
    };
    pollBids();
  }
  function renderDriverBids(bids, orderId, orderData) {
    const list = document.querySelector('.drivers-list');
    if (!list) return;
    list.innerHTML = '';
    bids.forEach(bid => {
      const card = document.createElement('div');
      card.className = 'driver-card';
      card.dataset.driverId = bid.driver_id;
      const initial = (bid.driver_name || '–í').charAt(0).toUpperCase();
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const rating = bid.driver_rating ? bid.driver_rating.toFixed(1) : '‚Äî';
      card.innerHTML = `
        <div class="driver-card-avatar">${initial}</div>
        <div class="driver-card-info">
          <div class="driver-card-name">${bid.driver_name || `–í–æ–¥–∏—Ç–µ–ª—å #${bid.driver_id}`}</div>
          <div class="driver-card-rating">
            <i class="fas fa-star"></i>
            <span>${rating}</span>
          </div>
          <div class="driver-car">${bid.car_brand} ‚Ä¢ ${bid.car_number}</div>
          <div style="font-size:14px;font-weight:500;color:var(--primary-color);margin-top:6px;">
            –ü—Ä–∏–±—ã—Ç–∏–µ: ${bid.arrival_minutes} –º–∏–Ω
          </div>
        </div>
        <button class="driver-select-btn">–í—ã–±—Ä–∞—Ç—å</button>
      `;
      card.querySelector('.driver-select-btn').addEventListener('click', () =>
        selectDriverForOrder(orderId, bid.driver_id, bid, orderData)
      );
      list.appendChild(card);
    });
  }
  async function selectDriverForOrder(orderId, driverId, bid, orderData) {
    try {
      const loader = document.getElementById('routeLoader');
      loader.classList.add('active');
      loader.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞...';
      loader.style.display = 'block';
      const res = await fetch(`${API_BASE_URL}/api/web/order/${orderId}/accept`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ driver_id: driverId })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(`–°–µ—Ä–≤–µ—Ä: ${res.status} ${err.detail || res.statusText}`);
      }
      const result = await res.json();
      if (result.success) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        closeDriverModal();
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–∫–∞–∑–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
        const fullOrderData = {
          orderId: orderId,
          driverName: bid.driver_name,
          driverInitials: (bid.driver_name || '‚Äî').charAt(0).toUpperCase(),
          driverId: bid.driver_id,
          driverUsername: bid.driver_username || null,
          carBrand: bid.car_brand,
          carNumber: bid.car_number,
          carYear: '2023',
          carColor: '–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π',
          pickupAddress: orderData.pickup_address,
          dropoffAddress: orderData.dropoff_address,
          price: orderData.price,
          distanceKm: orderData.distance_km,
          estimatedTime: orderData.estimated_time_min,
          passengers: orderData.passengers,
          driverRating: bid.driver_rating
        };
        localStorage.setItem('activeOrderData', JSON.stringify(fullOrderData));
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
        window.location.href = 'active-order.html';
      } else {
        throw new Error(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–¥–∏—Ç–µ–ª—è');
      }
    } catch (err) {
      console.error('Driver selection failed:', err);
      alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
      const loader = document.getElementById('routeLoader');
      loader.classList.remove('active');
      loader.style.display = 'none';
    }
  }
  // ======================
  // –≠–ö–†–ê–ù –û–¢–ú–ï–ù–´ –ó–ê–ö–ê–ó–ê
  // ======================
  function showCancelScreen() {
    const app = document.querySelector('.container');
    if (app) app.style.display = 'none';
    document.body.innerHTML = `
      <div class="cancel-screen" style="max-width:480px;width:100%;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.03);margin:10px;">
        <div style="padding:40px 20px;text-align:center;">
          <div style="font-size:48px;color:#d32f2f;margin-bottom:20px;"><i class="fas fa-times-circle"></i></div>
          <h2 style="font-size:24px;font-weight:600;margin-bottom:16px;">–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω</h2>
          <p style="font-size:16px;color:#616161;margin-bottom:30px;">–í—Ä–µ–º—è –Ω–∞ –≤—ã–±–æ—Ä –≤–æ–¥–∏—Ç–µ–ª—è –∏—Å—Ç–µ–∫–ª–æ.</p>
          <button class="action-btn" onclick="location.reload()" style="background:#000;color:white;padding:16px;border-radius:14px;font-size:16px;font-weight:600;width:100%;border:none;cursor:pointer;">
            <i class="fas fa-redo"></i> –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –ó–ê–ö–ê–ó
          </button>
        </div>
      </div>
      <style>
        body { background: #f8f9fa; margin:0; padding:0; min-height:100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      </style>
    `;
  }
  // ======================
  // –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í
  // ======================
  function getOrderHistory() {
    return JSON.parse(localStorage.getItem('orderHistory')) || [];
  }
  function saveOrderToHistory(order) {
    const history = getOrderHistory();
    history.unshift(order);
    if (history.length > 10) history.pop();
    localStorage.setItem('orderHistory', JSON.stringify(history));
  }
  function renderOrderHistory() {
    const history = getOrderHistory();
    if (history.length === 0) {
      historyOrdersContainer.innerHTML = `<div class="empty-history"><i class="fas fa-history"></i><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p></div>`;
      return;
    }
    historyOrdersContainer.innerHTML = history.map(order => {
      let statusClass = 'status-completed', statusText = '–í—ã–ø–æ–ª–Ω–µ–Ω';
      if (order.status === 'canceled') {
        statusClass = 'status-canceled';
        statusText = '–û—Ç–º–µ–Ω–µ–Ω';
      }
      return `
        <div class="history-order-item">
          <div class="order-header">
            <div class="order-date">${order.date}</div>
            <div class="order-status ${statusClass}">${statusText}</div>
          </div>
          <div class="route-info">
            <div class="route-point"><i class="fas fa-circle" style="font-size: 8px;"></i><span>${order.from}</span></div>
            <div class="route-point"><i class="fas fa-map-marker-alt"></i><span>${order.to}</span></div>
          </div>
          <div class="order-details">
            <div><div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="order-price">${order.price} ‚ÇΩ</span></div><div>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${order.distance} –∫–º</div></div>
            <button class="repeat-btn" data-order-id="${order.id}"><i class="fas fa-redo"></i><span>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</span></button>
          </div>
        </div>
      `;
    }).join('');
    document.querySelectorAll('.repeat-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        repeatOrder(btn.getAttribute('data-order-id'));
      });
    });
  }
  function repeatOrder(orderId) {
    const history = getOrderHistory();
    const order = history.find(o => o.id === orderId);
    if (order) {
      startInput.value = order.from;
      startInputFull.value = order.from;
      endInput.value = order.to;
      endInputFull.value = order.to;
      geocodeAddress(order.from, 'start');
      geocodeAddress(order.to, 'end');
      hideHistoryModal();
      setTimeout(() => document.querySelector('.rent-button').scrollIntoView({ behavior: 'smooth' }), 300);
    }
  }
  function showHistoryModal() {
    if (isHistoryModalOpen) return;
    isHistoryModalOpen = true;
    historyModalOverlay.classList.add('active');
    historyModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    renderOrderHistory();
  }
  function hideHistoryModal() {
    if (!isHistoryModalOpen) return;
    isHistoryModalOpen = false;
    historyModalOverlay.classList.remove('active');
    historyModal.classList.remove('active');
    document.body.style.overflow = 'auto';
  }
  // ======================
  // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–†–û–§–ò–õ–Ø
  // ======================
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
  async function refreshProfileData() {
    const userData = JSON.parse(localStorage.getItem('tg_user'));
    if (!userData) return null;
    try {
      // –Ø–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL
      const API_BASE_URL = window.location.hostname === 'localhost' 
        ? 'http://localhost:8004' 
        : 'https://taxibarsnz24.ru';
      console.log('üåê –ó–∞–ø—Ä–æ—Å –∫ API:', `${API_BASE_URL}/api/web/user/${userData.id}`);
      const res = await fetch(`${API_BASE_URL}/api/web/user/${userData.id}`, {
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        },
        method: 'GET'
      });
      console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', res.status);
      if (res.ok) {
        const profileData = await res.json();
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—É—á–µ–Ω—ã:', profileData);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('profileData', JSON.stringify(profileData));
        localStorage.setItem('profileLastUpdate', Date.now().toString());
        return profileData;
      } else {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
        let errorDetail = '';
        try {
          const errorData = await res.json();
          errorDetail = errorData.detail || errorData.message || '';
        } catch (e) {
          errorDetail = await res.text();
        }
        console.warn(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è. –°—Ç–∞—Ç—É—Å: ${res.status}, –î–µ—Ç–∞–ª–∏: ${errorDetail}`);
        // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        const cachedData = localStorage.getItem('profileData');
        if (cachedData) {
          console.log('üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è');
          return JSON.parse(cachedData);
        }
        return null;
      }
    } catch (error) {
      console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
      // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
      const cachedData = localStorage.getItem('profileData');
      if (cachedData) {
        console.log('üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏');
        return JSON.parse(cachedData);
      }
      return null;
    }
  }
  async function showProfileModal() {
    if (isProfileModalOpen) return;
    isProfileModalOpen = true;
    profileModalOverlay.classList.add('active');
    profileModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    const userData = JSON.parse(localStorage.getItem('tg_user'));
    if (!userData) {
      console.warn('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      hideProfileModal();
      window.location.href = 'login.html';
      return;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingState = `
      <div class="profile-header" style="min-height: 120px;">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%;">
          <div class="search-spinner" style="border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; margin-bottom: 15px; animation: spin 1s linear infinite;"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è...</p>
        </div>
      </div>
    `;
    const currentStats = document.querySelector('.profile-stats');
    if (currentStats) {
      currentStats.style.display = 'none';
    }
    try {
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
      console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º');
      const profileData = await refreshProfileData();
      if (!profileData) {
        console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è');
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è');
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      document.querySelector('.profile-name').textContent = 
        userData.first_name + (userData.last_name ? ' ' + userData.last_name : '');
      document.querySelector('.profile-phone').textContent = 
        userData.username ? `@${userData.username}` : (userData.phone || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
      // –ê–≤–∞—Ç–∞—Ä
      const modalAvatar = document.querySelector('.profile-avatar');
      if (userData.photo_url) {
        modalAvatar.innerHTML = `<img src="${userData.photo_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      } else {
        const initials = userData.first_name.charAt(0) + (userData.last_name ? userData.last_name.charAt(0) : '');
        modalAvatar.textContent = initials;
        modalAvatar.style.background = 'linear-gradient(135deg, #000 0%, #333 100%)';
      }
      // –°—Ç–∞—Ç—É—Å (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ monthly_ride_count)
      let status = "–°—Ç–∞–Ω–¥–∞—Ä—Ç", statusClass = "";
      if (profileData.monthly_ride_count >= 30) {
        status = "–ü–ª–∞—Ç–∏–Ω–∞"; statusClass = "stat-platinum";
      } else if (profileData.monthly_ride_count >= 20) {
        status = "–ó–æ–ª–æ—Ç–æ"; statusClass = "stat-gold";
      } else if (profileData.monthly_ride_count >= 10) {
        status = "–°–µ—Ä–µ–±—Ä–æ"; statusClass = "stat-silver";
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      const statusEl = document.querySelector('.stat-value:not(.stat-rating):not(.stat-orders)');
      if (statusEl) {
        statusEl.className = 'stat-value ' + statusClass;
        statusEl.textContent = status;
      }
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
      const ordersEl = document.querySelector('.stat-orders');
      if (ordersEl) {
        ordersEl.textContent = profileData.ride_count || 0;
      }
      // –†–µ–π—Ç–∏–Ω–≥ —Å –∑–≤–µ–∑–¥–∞–º–∏
      const ratingEl = document.querySelector('.stat-rating');
      const avgRating = profileData.average_rating || profileData.rating || 0;
      const fullStars = Math.floor(avgRating);
      const hasHalfStar = avgRating - fullStars >= 0.5;
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      let starsHTML = '';
      for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
      if (hasHalfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
      for (let i = 0; i < emptyStars; i++) starsHTML += '<i class="far fa-star"></i>';
      ratingEl.innerHTML = `
        ${starsHTML}
        <span style="margin-left: 4px;">${avgRating > 0 ? avgRating.toFixed(1) : '‚Äî'}</span>
      `;
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (currentStats) {
        currentStats.style.display = 'flex';
      }
      console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      if (currentStats) {
        currentStats.innerHTML = `
          <div style="width: 100%; text-align: center; padding: 20px; color: var(--error-color);">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            <p style="font-size: 12px; margin-top: 5px;">${error.message}</p>
            <button class="retry-profile-btn" style="margin-top: 15px; background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
              –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
            </button>
          </div>
        `;
        currentStats.style.display = 'block';
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–≤—Ç–æ—Ä–∞
        const retryBtn = document.querySelector('.retry-profile-btn');
        if (retryBtn) {
          retryBtn.addEventListener('click', async () => {
            await showProfileModal();
          });
        }
      }
    }
  }
  function hideProfileModal() {
    if (!isProfileModalOpen) return;
    isProfileModalOpen = false;
    profileModalOverlay.classList.remove('active');
    profileModal.classList.remove('active');
    document.body.style.overflow = 'auto';
  }
  // ======================
  // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
  // ======================
  function initProfileSync() {
    console.log('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
    document.addEventListener('visibilitychange', async function() {
      if (document.visibilityState === 'visible' && localStorage.getItem('isLoggedIn') === 'true') {
        console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.');
        const lastUpdate = localStorage.getItem('profileLastUpdate');
        const now = Date.now();
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –±–æ–ª–µ–µ 1 –º–∏–Ω—É—Ç—ã
        if (!lastUpdate || now - parseInt(lastUpdate) > 60000) {
          console.log('üîÑ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —É—Å—Ç–∞—Ä–µ–ª–∏. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.');
          await refreshProfileData();
        }
      }
    });
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (localStorage.getItem('isLoggedIn') === 'true') {
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç
      const lastUpdate = localStorage.getItem('profileLastUpdate');
      const now = Date.now();
      if (!lastUpdate || now - parseInt(lastUpdate) > 300000) {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        refreshProfileData();
      } else {
        console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã');
      }
    }
  }
  // ======================
  // WEB INTEGRATION ‚Äî –ó–ê–ú–ï–ù–ê –°–¢–ê–†–û–ô –õ–û–ì–ò–ö–ò
  // ======================
  function initIntegration() {
    console.log('‚úÖ Web integration initializing...');
    const elements = {
      orderButton: document.getElementById('orderButton'),
      startAddress: document.getElementById('startAddress'),
      endAddress: document.getElementById('endAddress'),
      startAddressFull: document.getElementById('startAddressFull'),
      endAddressFull: document.getElementById('endAddressFull'),
      routeLoader: document.getElementById('routeLoader'),
      routeDetails: document.getElementById('routeDetails'),
      priceDisplay: document.getElementById('priceDisplay'),
      distanceDisplay: document.getElementById('distanceDisplay'),
      estimatedTime: document.getElementById('estimatedTime'),
      calculatedValues: document.getElementById('calculated-values'),
      orderComment: document.getElementById('orderComment')
    };
    const missing = Object.keys(elements).filter(k => !elements[k]);
    if (missing.length > 0) {
      console.warn('Missing elements, retrying...', missing);
      setTimeout(initIntegration, 1000);
      return;
    }
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    function updateOrderButtonState() {
      const start = (elements.startAddressFull.value || elements.startAddress.value).trim();
      const end = (elements.endAddressFull.value || elements.endAddress.value).trim();
      if (start && end && start.length > 3 && end.length > 3) {
        elements.orderButton.disabled = false;
      } else {
        elements.orderButton.disabled = true;
        let msg = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –∞–¥—Ä–µ—Å–∞";
        if (!start && !end) msg = "–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è";
        else if (!start) msg = "–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è";
        else if (!end) msg = "–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è";
        if (elements.routeDetails) {
          elements.routeDetails.textContent = msg;
          elements.routeDetails.className = 'route-details error';
          elements.routeDetails.style.display = 'block';
        }
        if (elements.calculatedValues) elements.calculatedValues.style.display = 'none';
      }
    }
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    async function createOrderViaApi() {
      const userData = JSON.parse(localStorage.getItem('tg_user'));
      if (!userData) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
        window.location.href = 'login.html';
        return;
      }
      const activePassengerBtn = document.querySelector('.passenger-btn.active');
      const passengers = activePassengerBtn ? parseInt(activePassengerBtn.getAttribute('data-passengers'), 10) : 1;
      const pickup = elements.startAddressFull.value.trim() || elements.startAddress.value.trim();
      const dropoff = elements.endAddressFull.value.trim() || elements.endAddress.value.trim();
      const comment = elements.orderComment.value.trim() || '';
      // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω—ã, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –≤—Ä–µ–º–µ–Ω–∏
      let price = 150, distance = 0, estimatedTime = '15 –º–∏–Ω—É—Ç';
      try {
        const priceText = elements.priceDisplay.textContent;
        const distanceText = elements.distanceDisplay.textContent;
        const timeText = elements.estimatedTime.textContent;
        // –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É
        if (priceText && priceText !== '‚Äî ‚ÇΩ') {
          price = parseFloat(priceText.replace(/[^\d.,]/g, '').replace(',', '.')) || 150;
        }
        // –ü–∞—Ä—Å–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        if (distanceText && distanceText !== '‚Äî –∫–º') {
          distance = parseFloat(distanceText.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
        }
        // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è
        if (timeText && timeText !== '–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è' && timeText !== '‚Äî') {
          estimatedTime = timeText;
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —á–∏—Å–µ–ª
        if (isNaN(price) || price < 0) price = 150;
        if (isNaN(distance) || distance < 0) distance = 0;
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞:', e);
        price = 150;
        distance = 0;
        estimatedTime = '15 –º–∏–Ω—É—Ç';
      }
      if (!pickup || !dropoff) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –∞–¥—Ä–µ—Å–∞');
        return;
      }
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ—Ç–æ–≤ –ª–∏ –º–∞—Ä—à—Ä—É—Ç
      if (!isRouteReady) {
        alert('–ú–∞—Ä—à—Ä—É—Ç –µ—â–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.');
        return;
      }
      try {
        elements.orderButton.disabled = true;
        elements.routeLoader.classList.add('active');
        elements.routeLoader.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...';
        elements.routeLoader.style.display = 'block';
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const pickupCoords = startMarker.geometry.getCoordinates();
        const dropoffCoords = endMarker.geometry.getCoordinates();
        const orderPayload = {
          client_id: userData.id,
          pickup_address: pickup,
          dropoff_address: dropoff,
          comment: comment,
          passengers: passengers,
          price: price,
          distance_km: distance,
          estimated_time_min: estimatedTime,
          pickup_lat: pickupCoords[0],
          pickup_lon: pickupCoords[1],
          dropoff_lat: dropoffCoords[0],
          dropoff_lon: dropoffCoords[1]
        };
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        const tempOrderData = {
          ...orderPayload,
          timestamp: Date.now()
        };
        localStorage.setItem('last_order_data', JSON.stringify(tempOrderData));
        
        const res = await fetch(`${API_BASE_URL}/api/web/order/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderPayload)
        });
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status} ${err.detail || res.statusText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
        
        const result = await res.json();
        
        if (result.success && result.order_id) {
          console.log('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è.');
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
          await refreshProfileData();
          
          // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
          if (isProfileModalOpen) {
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø—Ä–æ—Ñ–∏–ª—è');
            await showProfileModal();
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è
          showSearchDriverModal(result.order_id, {
            pickup_address: pickup,
            dropoff_address: dropoff,
            price: price,
            distance_km: distance,
            estimated_time_min: estimatedTime,
            passengers: passengers,
            pickup_lat: pickupCoords[0],
            pickup_lon: pickupCoords[1],
            dropoff_lat: dropoffCoords[0],
            dropoff_lon: dropoffCoords[1]
          });
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
          const backupOrderData = {
            orderId: result.order_id,
            pickupAddress: pickup,
            dropoffAddress: dropoff,
            price: price,
            distanceKm: distance,
            estimatedTime: estimatedTime,
            passengers: passengers,
            createdAt: new Date().toISOString(),
            status: 'searching'
          };
          localStorage.setItem('backup_active_order', JSON.stringify(backupOrderData));
        } else {
          throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ—É–¥–∞—á–Ω—ã–π –æ—Ç–≤–µ—Ç');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ${err.message}`);
      } finally {
        elements.orderButton.disabled = false;
        elements.routeLoader.classList.remove('active');
        elements.routeLoader.style.display = 'none';
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
    function replaceOrderHandler() {
      if (elements.orderButton) {
        const clone = elements.orderButton.cloneNode(true);
        elements.orderButton.parentNode.replaceChild(clone, elements.orderButton);
        elements.orderButton = document.getElementById('orderButton');
        elements.orderButton.addEventListener('click', (e) => {
          e.preventDefault();
          createOrderViaApi();
        });
      }
    }
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –≤–≤–æ–¥–∞
    [elements.startAddress, elements.endAddress, elements.startAddressFull, elements.endAddressFull].forEach(el => {
      if (el) el.addEventListener('input', () => setTimeout(updateOrderButtonState, 100));
    });
    
    // –ó–∞–ø—É—Å–∫
    replaceOrderHandler();
    setInterval(updateOrderButtonState, 5000);
    setTimeout(updateOrderButtonState, 300);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è –≤ –∫–æ–Ω—Ü–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    initProfileSync();
    
    console.log('‚úÖ Web integration fully initialized with profile sync');
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
  profileAvatar.addEventListener('click', function(e) {
    e.stopPropagation();
    if (localStorage.getItem('isLoggedIn') === 'true') {
      showProfileModal();
    } else {
      window.location.href = 'login.html';
    }
  });
  
  // ======================
  // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
  // ======================
  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    window.addEventListener('popstate', function() {
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }
    });
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
    profileModalOverlay.addEventListener('click', hideProfileModal);
    historyModalClose.addEventListener('click', hideHistoryModal);
    historyModalOverlay.addEventListener('click', hideHistoryModal);
    searchDriverModalOverlay.addEventListener('click', function(e) {
      // –ù–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –∫–ª–∏–∫–æ–º –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
      // –≠—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –æ—Ç–º–µ–Ω–∏–ª –∏–ª–∏ –¥–æ–∂–¥–∞–ª—Å—è –ø–æ–∏—Å–∫–∞
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
    calculatedValues.style.display = 'none';
    document.querySelector('.price-placeholder').style.display = 'block';
    document.querySelector('.distance-placeholder').style.display = 'block';
    startInput.value = '';
    endInput.value = '';
    startInputFull.value = '';
    endInputFull.value = '';
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
  });
  
  function setupEventListeners() {
    retryLocationBtn.addEventListener('click', retryLocation);
    startInput.addEventListener('input', function() {
      if (this.value.trim() === '') {
        startInputFull.value = '';
        clearRoute();
      }
    });
    endInput.addEventListener('input', function() {
      if (this.value.trim() === '') {
        endInputFull.value = '';
        clearRoute();
      }
    });
  }
</script>
</body>
</html>
